var beepbox=function(t){"use strict";function e(t,e){for(let s=0;s<t.length;s++)t[s]*=e}function s(t){if(!function(t){return!(!t||t&t-1)}(t))throw new Error("FFT array length must be a power of 2.");return Math.round(Math.log(t)/Math.log(2))}function h(t){const e=t.length,h=s(e);if(e<4)throw new Error("FFT array length must be at least 4.");for(let s=h-1;s>=2;s--){const h=1<<s,i=h>>1,n=h<<1,a=2*Math.PI/n,l=Math.cos(a),r=Math.sin(a),o=2*l;for(let s=0;s<e;s+=n){const e=s,n=e+i,a=e+h,f=a+i,c=a+h,u=t[e],d=t[a];t[e]=u+d,t[n]*=2,t[a]=u-d,t[f]*=2;let m=l,p=-r,y=1,g=0;for(let s=1;s<i;s++){const h=e+s,i=a-s,n=a+s,l=c-s,r=t[h],f=t[i],u=t[n],d=t[l],b=r-f,v=u+d;t[h]=r+f,t[i]=d-u,t[n]=b*m-v*p,t[l]=v*m+b*p;const P=o*m-y,L=o*p-g;y=m,g=p,m=P,p=L}}}for(let s=0;s<e;s+=4){const e=s+1,h=s+2,i=s+3,n=t[s],a=2*t[e],l=t[h],r=2*t[i],o=n+l,f=n-l;t[s]=o+a,t[e]=o-a,t[h]=f+r,t[i]=f-r}!function(t){const e=t.length,h=s(e);if(h>16)throw new Error("FFT array length must not be greater than 2^16.");const i=16-h;for(let s=0;s<e;s++){let e;if(e=(43690&s)>>1|(21845&s)<<1,e=(52428&e)>>2|(13107&e)<<2,e=(61680&e)>>4|(3855&e)<<4,e=(e>>8|(255&e)<<8)>>i,e>s){let h=t[s];t[s]=t[e],t[e]=h}}}(t)}
/*!
    Copyright (c) 2012-2022 John Nesky and contributing authors

    Permission is hereby granted, free of charge, to any person obtaining a copy of
    this software and associated documentation files (the "Software"), to deal in
    the Software without restriction, including without limitation the rights to
    use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
    of the Software, and to permit persons to whom the Software is furnished to do
    so, subject to the following conditions:

    The above copyright notice and this permission notice shall be included in all
    copies or substantial portions of the Software.

    THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
    IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
    FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
    AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
    LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
    OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
    SOFTWARE.
    */class i{static t(t){let e=0;for(let s=0;s<t.length;s++)e+=t[s];const s=e/t.length;for(let e=0;e<t.length;e++)t[e]-=s;return new Float64Array(t)}static getDrumWave(t){let s=i.h[t];if(null==s)if(s=new Float32Array(32768),i.h[t]=s,0==t){let t=1;for(let e=0;e<32768;e++){s[e]=2*(1&t)-1;let h=t>>1;1==(t+h&1)&&(h+=16384),t=h}}else if(1==t)for(let t=0;t<32768;t++)s[t]=2*Math.random()-1;else if(2==t){let t=1;for(let e=0;e<32768;e++){s[e]=2*(1&t)-1;let h=t>>1;1==(t+h&1)&&(h+=32768),t=h}}else if(3==t){let t=1;for(let e=0;e<32767;e++){s[e]=2*(1&t)-1;let h=t>>2;1==(t+h&1)&&(h+=65536),t=h}}else if(4==t){let t=1;for(let e=0;e<32768;e++){s[e]=2*(1&t)-1;let h=t>>1;1==(t+h&1)&&(h+=40),t=h}}else if(5==t)i.drawNoiseSpectrum(s,10,11,1,1,0),i.drawNoiseSpectrum(s,11,14,-2,-2,0),h(s),e(s,1/Math.sqrt(s.length));else if(6==t)i.drawNoiseSpectrum(s,1,10,1,1,0),i.drawNoiseSpectrum(s,20,14,-2,-2,0),h(s),e(s,1/Math.sqrt(s.length));else if(7==t){let t=1;for(let e=0;e<32768;e++){s[e]=4*(1&t)*Math.random();let h=t>>1;1==(t+h&1)&&(h+=60),t=h}}else if(8==t){let t=1;for(let e=0;e<32768;e++){s[e]=(1&t)/2+.5;let h=t>>1;1==(t+h&1)&&(h-=40),t=h}}else{if(9!=t)throw new Error("Unrecognized drum index: "+t);for(let t=0;t<32768;t++)s[t]=2*Math.random()-1}return s}static drawNoiseSpectrum(t,e,s,h,i,n){const a=0|Math.pow(2,e),l=0|Math.pow(2,s),r=Math.log(2);for(let o=a;o<l;o++){let a=Math.pow(2,h+(i-h)*(Math.log(o)/r-e)/(s-e));a*=Math.pow(o/2048,n);const l=Math.random()*Math.PI*2;t[o]=Math.cos(l)*a,t[32768-o]=Math.sin(l)*a}}static generateSineWave(){const t=new Float64Array(i.sineWaveLength+1);for(let e=0;e<i.sineWaveLength+1;e++)t[e]=Math.sin(e*Math.PI*2/i.sineWaveLength);return t}}function n(t){const e={};for(let s=0;s<t.length;s++){const h=t[s];h.index=s,e[h.name]=h}const s=t;return s.dictionary=e,s}i.scales=n([{name:"easy :)",realName:"pentatonic major",flags:[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"easy :(",realName:"pentatonic minor",flags:[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1]},{name:"island :)",realName:"ryukyu",flags:[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0]},{name:"island :(",realName:"pelog selisir",flags:[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1]},{name:"blues :)",realName:"blues major",flags:[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1]},{name:"blues :(",realName:"blues",flags:[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1]},{name:"normal :)",realName:"ionian",flags:[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0]},{name:"normal :(",realName:"aeolian",flags:[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1]},{name:"dbl harmonic :)",realName:"double harmonic major",flags:[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0]},{name:"dbl harmonic :(",realName:"double harmonic minor",flags:[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0]},{name:"enigma",realName:"whole tone",flags:[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1]},{name:"expert",realName:"chromatic",flags:[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]},{name:"monotonic",realName:"monotonic",flags:[!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1]},{name:"no dabbing",realName:"no dabbing",flags:[!0,!0,!1,!0,!0,!0,!0,!0,!0,!1,!0,!1]}]),i.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],i.pitchNames=["C",null,"D",null,"E","F",null,"G",null,"A",null,"B"],i.oldKeys=["B","A‚ôØ","A","G‚ôØ","F‚ôØ","F","E","D‚ôØ","D","C‚ôØ","C"],i.keys=n([{name:"C",isWhiteKey:!0,basePitch:12},{name:"C‚ôØ",isWhiteKey:!1,basePitch:13},{name:"D",isWhiteKey:!0,basePitch:14},{name:"D‚ôØ",isWhiteKey:!1,basePitch:15},{name:"E",isWhiteKey:!0,basePitch:16},{name:"F",isWhiteKey:!0,basePitch:17},{name:"F‚ôØ",isWhiteKey:!1,basePitch:18},{name:"G",isWhiteKey:!0,basePitch:19},{name:"G‚ôØ",isWhiteKey:!1,basePitch:20},{name:"A",isWhiteKey:!0,basePitch:21},{name:"A‚ôØ",isWhiteKey:!1,basePitch:22},{name:"B",isWhiteKey:!0,basePitch:23}]),i.mixNames=["Type A (B & S)","Type B (M)","Type C"],i.sampleRateNames=["44100kHz","48000kHz","default","√ó4","√ó2","√∑2","√∑4","√∑8","√∑16"],i.tempoSteps=24,i.reverbRange=5,i.blendRange=4,i.riffRange=11,i.detuneRange=24,i.muffRange=24,i.beatsPerBarMin=1,i.beatsPerBarMax=24,i.barCountMin=1,i.barCountMax=256,i.patternsPerChannelMin=1,i.patternsPerChannelMax=64,i.instrumentsPerChannelMin=1,i.instrumentsPerChannelMax=64,i.pitchesPerOctave=12,i.drumCount=12,i.pitchOctaves=7,i.partNames=["√∑3 (triplets)","√∑4 (standard)","√∑6","√∑8","√∑16 (arpfest)","√∑12","√∑9","√∑5","√∑50","√∑24"],i.partCounts=[3,4,6,8,16,12,9,5,50,24],i.waveNames=["triangle","square","pulse wide","pulse narrow","sawtooth","double saw","double pulse","spiky","plateau","glitch","10% pulse","sunsoft bass","loud pulse","sax","guitar","sine","atari bass","atari pulse","1% pulse","curved sawtooth","viola","brass","acoustic bass","lyre","ramp pulse","piccolo","squaretooth","flatline","pnryshk a (u5)","pnryshk b (riff)"],i.waveVolumes=[1,.5,.5,.5,.65,.5,.4,.4,.94,.5,.5,1,.6,.1,.25,1,1,1,1,1,1,1,1,.2,.2,.9,.9,1,.4,.5],i.drumNames=["retro","white","periodic","detuned periodic","shine","hollow","deep","cutter","metallic","snare"],i.drumVolumes=[.25,1,.4,.3,.3,1.5,1.5,.25,1,1],i.drumBasePitches=[69,69,69,69,69,96,120,96,96,69],i.drumPitchFilterMult=[100,8,100,100,100,1,100,100,100,100],i.drumWaveIsSoft=[!1,!0,!1,!1,!1,!0,!0,!1,!1,!1],i.h=[null,null,null,null,null,null,null,null,null,null],i.pwmwaveNames=["5%","10%","15%","20%","25%","30%","35%","40%","45%","50%"],i.pwmwaveVolumes=[1,1,1,1,1,1,1,1,1,1],i.filterNames=["none","sustain sharp","sustain medium","sustain soft","decay sharp","decay medium","decay soft","decay drawn","fade sharp","fade medium","fade soft","ring","muffled","submerged","shift","overtone","woosh","undertone"],i.filterBases=[0,2,3.5,5,1,2.5,4,1,5,7.5,10,-1,4,6,0,1,2,5],i.filterDecays=[0,0,0,0,10,7,4,.5,-10,-7,-4,.2,.2,.3,0,0,-6,0],i.filterVolumes=[.2,.4,.7,1,.5,.75,1,.5,.4,.7,1,.5,.75,.4,.4,1,.5,1.75],i.transitionNames=["seamless","sudden","smooth","slide","trill","click","bow","blip"],i.effectNames=["none","vibrato light","vibrato delayed","vibrato heavy","tremolo light","tremolo heavy","alien","stutter","strum"],i.effectVibratos=[0,.15,.3,.45,0,0,1,0,.05],i.effectTremolos=[0,0,0,0,.25,.5,0,1,.025],i.effectVibratoDelays=[0,0,3,0,0,0,0,0],i.chorusNames=["union","shimmer","hum","honky tonk","dissonant","fifths","octaves","spinner","detune","bowed","rising","vibrate","fourths","bass","dirty","stationary","harmonic (legacy)","recurve","voiced","fluctuate"],i.chorusIntervals=[0,.02,.05,.1,.25,3.5,6,.02,0,.02,1,3.5,4,0,0,3.5,0,.005,.25,12],i.chorusOffsets=[0,0,0,0,0,3.5,6,0,.25,0,.7,7,4,-7,.1,0,0,0,3,0],i.chorusVolumes=[.9,.9,1,1,.95,.95,.9,1,1,1,.95,.975,.95,1,.975,.9,1,1,.9,1],i.chorusSigns=[1,1,1,1,1,1,1,1,1,-1,1,1,1,1,1,-1,1,-1,1,1],i.chorusRiffApp=[0,1,1,1,1,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1],i.chorusHarmonizes=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1],i.harmDisplay=["arpeggio","duet","chord","seventh","half arpeggio","arp-chord"],i.harmNames=[0,1,2,3,4,5],i.fmChorusDisplay=["none","default","detune","honky tonk","consecutive","alt. major thirds","alt. minor thirds","fifths","octaves"],i.fmChorusNames=[0,1,2,3,4,5,6,7,8],i.imuteNames=["‚óâ","‚óé"],i.imuteValues=[1,0],i.octoffNames=["none","+2 (2 octaves)","+1 1/2 (octave and fifth)","+1 (octave)","+1/2 (fifth)","-1/2 (fifth)","-1 (octave)","-1 1/2 (octave and fifth)","-2 (2 octaves"],i.octoffValues=[0,24,19,12,7,-7,-12,-19,-24],i.volumeNames=["loudest","loud","medium","quiet","quietest","mute","i","couldnt","be","bothered"],i.volumeValues=[0,.25,.5,.75,1,1.25,1.5,1.75,2,-1],i.volumeMValues=[0,.5,1,1.5,2,-1],i.ipanValues=[-1,-.75,-.5,-.25,0,.25,.5,.75,1],i.operatorCount=4,i.operatorAlgorithmNames=["1‚Üê(2‚ÄÇ3‚ÄÇ4)","1‚Üê(2‚ÄÇ3‚Üê4)","1‚Üê2‚Üê(3‚ÄÇ4)","1‚Üê(2‚ÄÇ3)‚Üê4","1‚Üê2‚Üê3‚Üê4","1‚Üê3‚ÄÉ2‚Üê4","1‚ÄÉ2‚Üê(3‚ÄÇ4)","1‚ÄÉ2‚Üê3‚Üê4","(1‚ÄÇ2)‚Üê3‚Üê4","(1‚ÄÇ2)‚Üê(3‚ÄÇ4)","1‚ÄÉ2‚ÄÉ3‚Üê4","(1‚ÄÇ2‚ÄÇ3)‚Üê4","1‚ÄÉ2‚ÄÉ3‚ÄÉ4"],i.midiAlgorithmNames=["1<(2 3 4)","1<(2 3<4)","1<2<(3 4)","1<(2 3)<4","1<2<3<4","1<3 2<4","1 2<(3 4)","1 2<3<4","(1 2)<3<4","(1 2)<(3 4)","1 2 3<4","(1 2 3)<4","1 2 3 4"],i.operatorModulatedBy=[[[2,3,4],[],[],[]],[[2,3],[],[4],[]],[[2],[3,4],[],[]],[[2,3],[4],[4],[]],[[2],[3],[4],[]],[[3],[4],[],[]],[[],[3,4],[],[]],[[],[3],[4],[]],[[3],[3],[4],[]],[[3,4],[3,4],[],[]],[[],[],[4],[]],[[4],[4],[4],[]],[[],[],[],[]]],i.operatorAssociatedCarrier=[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,2,1,2],[1,2,2,2],[1,2,2,2],[1,2,2,2],[1,2,2,2],[1,2,3,3],[1,2,3,3],[1,2,3,4]],i.operatorCarrierCounts=[1,1,1,1,1,2,2,2,2,2,3,3,4],i.operatorCarrierChorus=[[0,0,0,0],[0,.04,-.073,.091],[.5,.54,.427,.591],[0,.26,-.45,.67],[0,1,2,3],[0,4,7,11],[0,3,7,10],[0,7,14,21],[0,12,24,36]],i.operatorAmplitudeMax=15,i.operatorFrequencyNames=["1√ó","~1√ó","2√ó","~2√ó","3√ó","4√ó","5√ó","6√ó","7√ó","8√ó","9√ó","10√ó","11√ó","13√ó","16√ó","20√ó"],i.midiFrequencyNames=["1x","~1x","2x","~2x","3x","4x","5x","6x","7x","8x","9x","10x","11x","13x","16x","20x"],i.operatorFrequencies=[1,1,2,2,3,4,5,6,7,8,9,10,11,13,16,20],i.operatorHzOffsets=[0,1.5,0,-1.3,0,0,0,0,0,0,0,0,0,0,0,0],i.operatorAmplitudeSigns=[1,-1,1,-1,1,1,1,1,1,1,1,1,1,1,1,1],i.operatorEnvelopeNames=["custom","steady","punch","flare 1","flare 2","flare 3","pluck 1","pluck 2","pluck 3","swell 1","swell 2","swell 3","tremolo1","tremolo2","tremolo3","custom flare","custom tremolo","flute 1","flute 2","flute 3"],i.operatorEnvelopeType=[0,1,2,3,3,3,4,4,4,4,4,4,5,5,5,3,5,6,6,6],i.operatorSpecialCustomVolume=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!1],i.operatorEnvelopeSpeed=[0,0,0,32,8,2,32,8,2,32,8,2,4,2,1,8,0,16,8,4],i.operatorEnvelopeInverted=[!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1],i.operatorFeedbackNames=["1‚ü≤","2‚ü≤","3‚ü≤","4‚ü≤","1‚ü≤‚ÄÉ2‚ü≤","3‚ü≤‚ÄÉ4‚ü≤","1‚ü≤‚ÄÉ2‚ü≤‚ÄÉ3‚ü≤‚ÄÉ","2‚ü≤‚ÄÉ3‚ü≤‚ÄÉ4‚ü≤‚ÄÉ","1‚ü≤‚ÄÉ2‚ü≤‚ÄÉ3‚ü≤‚ÄÉ4‚ü≤‚ÄÉ","1‚Üí2","1‚Üí3","1‚Üí4","2‚Üí3","2‚Üí4","3‚Üí4","1‚Üí3‚ÄÉ2‚Üí4","1‚Üí4‚ÄÉ2‚Üí3","1‚Üí2‚Üí3‚Üí4","1üóò2","1üóò3","1üóò4","2üóò3","2üóò4","3üóò4"],i.midiFeedbackNames=["1","2","3","4","1 2","3 4","1 2 3","2 3 4","1 2 3 4","1>2","1>3","1>4","2>3","2>4","3>4","1>3 2>4","1>4 2>3","1>2>3>4","1-2","1-3","1-4","2-3","2-4","3-4"],i.operatorFeedbackIndices=[[[1],[],[],[]],[[],[2],[],[]],[[],[],[3],[]],[[],[],[],[4]],[[1],[2],[],[]],[[],[],[3],[4]],[[1],[2],[3],[]],[[],[2],[3],[4]],[[1],[2],[3],[4]],[[],[1],[],[]],[[],[],[1],[]],[[],[],[],[1]],[[],[],[2],[]],[[],[],[],[2]],[[],[],[],[3]],[[],[],[1],[2]],[[],[],[2],[1]],[[],[1],[2],[3]],[[2],[1],[],[]],[[3],[],[1],[]],[[4],[],[],[1]],[[],[3],[2],[]],[[],[4],[],[2]],[[],[],[4],[3]]],i.pitchChannelTypeNames=["chip","FM (expert)","PWM (beta)"],i.pitchChannelTypeValues=[0,1,3],i.drumChannelTypeNames=["noise"],i.instrumentTypeNames=["chip","FM","noise","PWM"],i.oldThemeNames=["Default","ModBox 2.0","Artic","Cinnamon Roll [!]","Ocean","Rainbow [!]","Float [!]","Windows","Grassland","Dessert","Kahootiest","Beam to the Bit [!]","Pretty Egg","Poniryoshka","Gameboy [!]","Woodkid","Midnight","Snedbox","unnamed","Piano [!] [‚Üª]","Halloween","FrozenOver‚ùÑÔ∏è"],i.channelOneBrightColorPallet="#25f3ff",i.channelTwoBrightColorPallet="#44ff44",i.channelThreeBrightColorPallet="#ffff25",i.channelFourBrightColorPallet="#ff9752",i.channelFiveBrightColorPallet="#ff90ff",i.channelSixBrightColorPallet="#9f31ea",i.channelSevenBrightColorPallet="#2b6aff",i.channelEightBrightColorPallet="#00ff9f",i.channelNineBrightColorPallet="#ffbf00",i.channelTenBrightColorPallet="#d85d00",i.channelElevenBrightColorPallet="#ff00a1",i.channelTwelveBrightColorPallet="#c26afc",i.channelThirteenBrightColorPallet="#ff1616",i.channelFourteenBrightColorPallet="#ffffff",i.channelFifteenBrightColorPallet="#768dfc",i.channelSixteenBrightColorPallet="#a5ff00",i.channelOneDimColorPallet="#0099a1",i.channelTwoDimColorPallet="#439143",i.channelThreeDimColorPallet="#a1a100",i.channelFourDimColorPallet="#c75000",i.channelFiveDimColorPallet="#d020d0",i.channelSixDimColorPallet="#552377",i.channelSevenDimColorPallet="#221b89",i.channelEightDimColorPallet="#00995f",i.channelNineDimColorPallet="#d6b03e",i.channelTenDimColorPallet="#b25915",i.channelElevenDimColorPallet="#891a60",i.channelTwelveDimColorPallet="#965cbc",i.channelThirteenDimColorPallet="#991010",i.channelFourteenDimColorPallet="#aaaaaa",i.channelFifteenDimColorPallet="#5869BD",i.channelSixteenDimColorPallet="#7c9b42",i.pitchChannelColorsDim=[i.channelOneDimColorPallet,i.channelTwoDimColorPallet,i.channelThreeDimColorPallet,i.channelFourDimColorPallet,i.channelFiveDimColorPallet,i.channelSixDimColorPallet,i.channelSevenDimColorPallet,i.channelEightDimColorPallet,i.channelNineDimColorPallet,i.channelTenDimColorPallet,i.channelElevenDimColorPallet,i.channelTwelveDimColorPallet],i.pitchChannelColorsBright=[i.channelOneBrightColorPallet,i.channelTwoBrightColorPallet,i.channelThreeBrightColorPallet,i.channelFourBrightColorPallet,i.channelFiveBrightColorPallet,i.channelSixBrightColorPallet,i.channelSevenBrightColorPallet,i.channelEightBrightColorPallet,i.channelNineBrightColorPallet,i.channelTenBrightColorPallet,i.channelElevenBrightColorPallet,i.channelTwelveBrightColorPallet],i.pitchNoteColorsDim=[i.channelOneDimColorPallet,i.channelTwoDimColorPallet,i.channelThreeDimColorPallet,i.channelFourDimColorPallet,i.channelFiveDimColorPallet,i.channelSixDimColorPallet,i.channelSevenDimColorPallet,i.channelEightDimColorPallet,i.channelNineDimColorPallet,i.channelTenDimColorPallet,i.channelElevenDimColorPallet,i.channelTwelveDimColorPallet],i.pitchNoteColorsBright=[i.channelOneBrightColorPallet,i.channelTwoBrightColorPallet,i.channelThreeBrightColorPallet,i.channelFourBrightColorPallet,i.channelFiveBrightColorPallet,i.channelSixBrightColorPallet,i.channelSevenBrightColorPallet,i.channelEightBrightColorPallet,i.channelNineBrightColorPallet,i.channelTenBrightColorPallet,i.channelElevenBrightColorPallet,i.channelTwelveBrightColorPallet],i.drumChannelColorsDim=[i.channelThirteenDimColorPallet,i.channelFourteenDimColorPallet,i.channelFifteenDimColorPallet,i.channelSixteenDimColorPallet],i.drumChannelColorsBright=[i.channelThirteenBrightColorPallet,i.channelFourteenBrightColorPallet,i.channelFifteenBrightColorPallet,i.channelSixteenBrightColorPallet],i.drumNoteColorsDim=[i.channelThirteenDimColorPallet,i.channelFourteenDimColorPallet,i.channelFifteenDimColorPallet,i.channelSixteenDimColorPallet],i.drumNoteColorsBright=[i.channelThirteenBrightColorPallet,i.channelFourteenBrightColorPallet,i.channelFifteenBrightColorPallet,i.channelSixteenBrightColorPallet],i.midiPitchChannelNames=["cyan channel","yellow channel","orange channel","green channel","purple channel","blue channel"],i.midiDrumChannelNames=["gray channel","brown channel","indigo channel"],i.midiSustainInstruments=[71,80,70,68,81,81,81,81,74],i.midiDecayInstruments=[46,46,6,24,25,25,106,106,33],i.drumInterval=6,i.pitchCount=37,i.maxPitch=84,i.pitchChannelCountMin=0,i.pitchChannelCountMax=12,i.drumChannelCountMin=0,i.drumChannelCountMax=4,i.waves=[i.t([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15]),i.t([1,-1]),i.t([1,-1,-1,-1]),i.t([1,-1,-1,-1,-1,-1,-1,-1]),i.t([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31]),i.t([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2]),i.t([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1]),i.t([1,-1,1,-1,1,0]),i.t([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2]),i.t([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1]),i.t([1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([0,.1875,.3125,.5625,.5,.75,.875,1,1,.6875,.5,.625,.625,.5,.375,.5625,.4375,.5625,.4375,.4375,.3125,.1875,.1875,.375,.5625,.5625,.5625,.5625,.5625,.4375,.25,0]),i.t([1,.7,.1,.1,0,0,0,0,0,.1,.2,.15,.25,.125,.215,.345,4]),i.t([1/15,.2,5/15,9,.06]),i.t([-.5,3.5,3,-.5,-.25,-1]),i.t([0,.05,.125,.2,.25,.3,.425,.475,.525,.625,.675,.725,.775,.8,.825,.875,.9,.925,.95,.975,.98,.99,.995,1,.995,.99,.98,.975,.95,.925,.9,.875,.825,.8,.775,.725,.675,.625,.525,.475,.425,.3,.25,.2,.125,.05,0,-.05,-.125,-.2,-.25,-.3,-.425,-.475,-.525,-.625,-.675,-.725,-.775,-.8,-.825,-.875,-.9,-.925,-.95,-.975,-.98,-.99,-.995,-1,-.995,-.99,-.98,-.975,-.95,-.925,-.9,-.875,-.825,-.8,-.775,-.725,-.675,-.625,-.525,-.475,-.425,-.3,-.25,-.2,-.125,-.05]),i.t([1,1,1,1,0,1,0,1,1,0,0,1,0,0,0]),i.t([0,0,1,1,1,1,1,1,1,1,1,1,1,1,1]),i.t([1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,.5,1/3,1/4]),i.t([-.9,-1,-.85,-.775,-.7,-.6,-.5,-.4,-.325,-.225,-.2,-.125,-.1,-.11,-.125,-.15,-.175,-.18,-.2,-.21,-.22,-.21,-.2,-.175,-.15,-.1,-.5,.75,.11,.175,.2,.25,.26,.275,.26,.25,.225,.2,.19,.18,.19,.2,.21,.22,.23,.24,.25,.26,.275,.28,.29,.3,.29,.28,.27,.26,.25,.225,.2,.175,.15,.1,.075,0,-.01,-.025,.025,.075,.2,.3,.475,.6,.75,.85,.85,1,.99,.95,.8,.675,.475,.275,.01,-.15,-.3,-.475,-.5,-.6,-.71,-.81,-.9,-1,-.9]),i.t([-1,-.95,-.975,-.9,-.85,-.8,-.775,-.65,-.6,-.5,-.475,-.35,-.275,-.2,-.125,-.05,0,.075,.125,.15,.2,.21,.225,.25,.225,.21,.2,.19,.175,.125,.1,.075,.06,.05,.04,.025,.04,.05,.1,.15,.225,.325,.425,.575,.7,.85,.95,1,.9,.675,.375,.2,.275,.4,.5,.55,.6,.625,.65,.65,.65,.65,.64,.6,.55,.5,.4,.325,.25,.15,.05,-.05,-.15,-.275,-.35,-.45,-.55,-.65,-.7,-.78,-.825,-.9,-.925,-.95,-.975]),i.t([1,0,.1,-.1,-.2,-.4,-.3,-1]),i.t([1,-1,4,2.15,4.13,5.15,0,-.05,1]),i.t([6.1,-2.9,1.4,-2.9]),i.t([1,4,2,1,-.1,-1,-.12]),i.t([.2,1,2.6,1,0,-2.4]),i.t([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,.1,.2,.3,.4,.5,.6,.7,.8,.9]),i.t([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0]),i.t([1,-.9,.8,-.7,.6,-.5,.4,-.3,.2,-.1,0,-.1,.2,-.3,.4,-.5,.6,-.7,.8,-.9,1])],i.wavesMixC=[i.t([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15]),i.t([1,-1]),i.t([1,-1,-1,-1]),i.t([1,-1,-1,-1,-1,-1,-1,-1]),i.t([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31]),i.t([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2]),i.t([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1]),i.t([1,-1,1,-1,1,0]),i.t([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2]),i.t([1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,-1,-1]),i.t([1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([0,.1875,.3125,.5625,.5,.75,.875,1,1,.6875,.5,.625,.625,.5,.375,.5625,.4375,.5625,.4375,.4375,.3125,.1875,.1875,.375,.5625,.5625,.5625,.5625,.5625,.4375,.25,0]),i.t([1,.7,.1,.1,0,0,0,0,0,.1,.2,.15,.25,.125,.215,.345,4]),i.t([1/15,.2,5/15,9,.06]),i.t([-.5,3.5,3,-.5,-.25,-1]),i.t([0,.05,.125,.2,.25,.3,.425,.475,.525,.625,.675,.725,.775,.8,.825,.875,.9,.925,.95,.975,.98,.99,.995,1,.995,.99,.98,.975,.95,.925,.9,.875,.825,.8,.775,.725,.675,.625,.525,.475,.425,.3,.25,.2,.125,.05,0,-.05,-.125,-.2,-.25,-.3,-.425,-.475,-.525,-.625,-.675,-.725,-.775,-.8,-.825,-.875,-.9,-.925,-.95,-.975,-.98,-.99,-.995,-1,-.995,-.99,-.98,-.975,-.95,-.925,-.9,-.875,-.825,-.8,-.775,-.725,-.675,-.625,-.525,-.475,-.425,-.3,-.25,-.2,-.125,-.05]),i.t([1,1,1,1,0,1,0,1,1,0,0,1,0,0,0]),i.t([0,0,1,1,1,1,1,1,1,1,1,1,1,1,1]),i.t([1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,.5,1/3,1/4]),i.t([-.9,-1,-.85,-.775,-.7,-.6,-.5,-.4,-.325,-.225,-.2,-.125,-.1,-.11,-.125,-.15,-.175,-.18,-.2,-.21,-.22,-.21,-.2,-.175,-.15,-.1,-.5,.75,.11,.175,.2,.25,.26,.275,.26,.25,.225,.2,.19,.18,.19,.2,.21,.22,.23,.24,.25,.26,.275,.28,.29,.3,.29,.28,.27,.26,.25,.225,.2,.175,.15,.1,.075,0,-.01,-.025,.025,.075,.2,.3,.475,.6,.75,.85,.85,1,.99,.95,.8,.675,.475,.275,.01,-.15,-.3,-.475,-.5,-.6,-.71,-.81,-.9,-1,-.9]),i.t([-1,-.95,-.975,-.9,-.85,-.8,-.775,-.65,-.6,-.5,-.475,-.35,-.275,-.2,-.125,-.05,0,.075,.125,.15,.2,.21,.225,.25,.225,.21,.2,.19,.175,.125,.1,.075,.06,.05,.04,.025,.04,.05,.1,.15,.225,.325,.425,.575,.7,.85,.95,1,.9,.675,.375,.2,.275,.4,.5,.55,.6,.625,.65,.65,.65,.65,.64,.6,.55,.5,.4,.325,.25,.15,.05,-.05,-.15,-.275,-.35,-.45,-.55,-.65,-.7,-.78,-.825,-.9,-.925,-.95,-.975]),i.t([.7,0,.1,-.1,-.2,-.4,-.3,-.7]),i.t([1,-1,4,2.15,4.1,5.05,0,-.05,1]),i.t([4.5,-1.7,1,-1.7]),i.t([.1,.4,.2,.1,-.1,-1,-.12]),i.t([.03,.13,.3,1,0,-.26]),i.t([2,1.75,1.5,1.25,1,.75,.5,.25,0,.25,.5,.75,1,1.25,1.5,1.75]),i.t([1,1.9,1.8,1.7,1.6,1.5,1.4,1.3,1.2,1.1,1]),i.t([-1,-.9,.8,-.7,.6,-.5,.4,-.3,.2,-.1,0,-.1,.2,-.3,.4,-.5,.6,-.7,.8,-.9,-1])],i.pwmwaves=[i.t([1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,1,1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,1,1,1,-1,-1,-1,-1,-1,-1]),i.t([1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]),i.t([1,1,1,1,1,-1,-1,-1,-1,-1])],i.sineWaveLength=256,i.sineWaveMask=i.sineWaveLength-1,i.sineWave=i.generateSineWave();class a{constructor(t,e,s,h){this.i=[],this.l=0;for(let i=s;i<h;i++){const s=t[e.charCodeAt(i)];this.i.push(s>>5&1),this.i.push(s>>4&1),this.i.push(s>>3&1),this.i.push(s>>2&1),this.i.push(s>>1&1),this.i.push(1&s)}}read(t){let e=0;for(;t>0;)e<<=1,e+=this.i[this.l++],t--;return e}readLongTail(t,e){let s=t,h=e;for(;this.i[this.l++];)s+=1<<h,h++;for(;h>0;)h--,this.i[this.l++]&&(s+=1<<h);return s}readPartDuration(){return this.readLongTail(1,2)}readPinCount(){return this.readLongTail(1,0)}readPitchInterval(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)}}class l{constructor(){this.i=[]}write(t,e){for(t--;t>=0;)this.i.push(e>>>t&1),t--}writeLongTail(t,e,s){if(s<t)throw new Error("value out of bounds");s-=t;let h=e;for(;s>=1<<h;)this.i.push(1),s-=1<<h,h++;for(this.i.push(0);h>0;)h--,this.i.push(s>>>h&1)}writePartDuration(t){this.writeLongTail(1,2,t)}writePinCount(t){this.writeLongTail(1,0,t)}writePitchInterval(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))}concat(t){this.i=this.i.concat(t.i)}encodeBase64(t,e){for(let s=0;s<this.i.length;s+=6){const h=this.i[s]<<5|this.i[s+1]<<4|this.i[s+2]<<3|this.i[s+3]<<2|this.i[s+4]<<1|this.i[s+5];e.push(t[h])}return e}lengthBase64(){return Math.ceil(this.i.length/6)}}class r{constructor(t){this.frequency=0,this.amplitude=0,this.envelope=0,this.reset(t)}reset(t){this.frequency=0,this.amplitude=t<=1?i.operatorAmplitudeMax:0,this.envelope=1}copy(t){this.frequency=t.frequency,this.amplitude=t.amplitude,this.envelope=t.envelope}}function o(t,e,s){return{interval:t,time:e,volume:s}}function f(t,e,s,h,i=!1){return{pitches:[t],pins:[o(0,0,h),o(0,s-e,i?0:h)],start:e,end:s}}class c{constructor(){this.type=0,this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.harm=0,this.fmChorus=1,this.imute=0,this.octoff=0,this.chorus=0,this.volume=0,this.ipan=4,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1,this.operators=[];for(let t=0;t<i.operatorCount;t++)this.operators.push(new r(t))}reset(){this.type=0,this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.harm=0,this.fmChorus=1,this.imute=0,this.ipan=4,this.octoff=0,this.chorus=0,this.volume=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1;for(let t=0;t<this.operators.length;t++)this.operators[t].reset(t)}setTypeAndReset(t){switch(this.type=t,t){case 0:case 3:this.wave=1,this.filter=1,this.transition=1,this.effect=0,this.harm=0,this.imute=0,this.ipan=4,this.octoff=0,this.chorus=0,this.volume=0;break;case 1:this.wave=1,this.transition=1,this.volume=0,this.imute=0,this.ipan=4,this.harm=0,this.octoff=0;break;case 2:this.transition=1,this.octoff=0,this.fmChorus=1,this.ipan=4,this.effect=0,this.algorithm=0,this.feedbackType=0,this.feedbackAmplitude=0,this.feedbackEnvelope=1,this.volume=0;for(let t=0;t<this.operators.length;t++)this.operators[t].reset(t)}}copy(t){this.type=t.type,this.wave=t.wave,this.filter=t.filter,this.transition=t.transition,this.effect=t.effect,this.chorus=t.chorus,this.volume=t.volume,this.harm=t.harm,this.fmChorus=t.fmChorus,this.imute=t.imute,this.ipan=t.ipan,this.octoff=t.octoff,this.algorithm=t.algorithm,this.feedbackType=t.feedbackType,this.feedbackAmplitude=t.feedbackAmplitude,this.feedbackEnvelope=t.feedbackEnvelope;for(let e=0;e<this.operators.length;e++)this.operators[e].copy(t.operators[e])}}class u{constructor(){this.octave=0,this.instruments=[],this.patterns=[],this.bars=[]}}class d{constructor(){this.notes=[],this.instrument=0}cloneNotes(){const t=[];for(const e of this.notes){const s=f(-1,e.start,e.end,3);s.pitches=e.pitches.concat(),s.pins=[];for(const t of e.pins)s.pins.push(o(t.interval,t.time,t.volume));t.push(s)}return t}reset(){this.notes.length=0,this.instrument=0}}class m{constructor(t){this.channels=[],this.o=[],null!=t?this.fromBase64String(t):this.initToDefault(!0)}getChannelCount(){return this.pitchChannelCount+this.drumChannelCount}getChannelUnusedCount(){return i.pitchChannelCountMax+i.drumChannelCountMax-(this.pitchChannelCount+this.drumChannelCount)}getTimeSig(){return this.beatsPerBar+"/"+this.partsPerBeat+" with "+this.barCount+" bars."}getScaleNKey(){return' "'+i.scales[this.scale].name+'" and your key is '+i.keys[this.key].name}getChannelIsDrum(t){return t>=this.pitchChannelCount}getChannelColorDim(t){return t<this.pitchChannelCount?i.pitchChannelColorsDim[t]:i.drumChannelColorsDim[t-this.pitchChannelCount]}getChannelColorBright(t){return t<this.pitchChannelCount?i.pitchChannelColorsBright[t]:i.drumChannelColorsBright[t-this.pitchChannelCount]}getNoteColorDim(t){return t<this.pitchChannelCount?i.pitchNoteColorsDim[t]:i.drumNoteColorsDim[t-this.pitchChannelCount]}getNoteColorBright(t){return t<this.pitchChannelCount?i.pitchNoteColorsBright[t]:i.drumNoteColorsBright[t-this.pitchChannelCount]}initToDefault(t=!0){if(this.scale=0,this.setSongTheme="none",this.key=i.keys.map((t=>t.name)).indexOf("C"),this.mix=1,this.sampleRate=2,this.loopStart=0,this.loopLength=4,this.tempo=7,this.reverb=0,this.blend=0,this.riff=0,this.detune=0,this.muff=0,this.beatsPerBar=8,this.barCount=16,this.patternsPerChannel=8,this.partsPerBeat=4,this.instrumentsPerChannel=1,t){this.pitchChannelCount=4,this.drumChannelCount=1;for(let t=0;t<this.getChannelCount();t++){this.channels.length<=t&&(this.channels[t]=new u);const e=this.channels[t];e.octave=4-t;for(let t=0;t<this.patternsPerChannel;t++)e.patterns.length<=t?e.patterns[t]=new d:e.patterns[t].reset();e.patterns.length=this.patternsPerChannel;for(let t=0;t<this.instrumentsPerChannel;t++)e.instruments.length<=t?e.instruments[t]=new c:e.instruments[t].reset();e.instruments.length=this.instrumentsPerChannel;for(let t=0;t<this.barCount;t++)e.bars[t]=t<4?1:0;e.bars.length=this.barCount}this.channels.length=this.getChannelCount()}}toBase64String(){let t,e=[];const s=m.u;e.push(m.m),e.push(s[m.p]),e.push(110,s[this.pitchChannelCount],s[this.drumChannelCount]),e.push(122);var h=encodeURIComponent(this.setSongTheme);e.push(s[h.length>>6],s[63&h.length]);for(let t=0;t<h.length;t++)e.push(h.charCodeAt(t));e.push(115,s[this.scale]),e.push(117,s[this.mix]),e.push(124,s[this.sampleRate]),e.push(107,s[this.key]),e.push(108,s[this.loopStart>>6],s[63&this.loopStart]),e.push(101,s[this.loopLength-1>>6],s[this.loopLength-1&63]),e.push(116,s[this.tempo]),e.push(109,s[this.reverb]),e.push(120,s[this.blend]),e.push(121,s[this.riff]),e.push(72,s[this.detune]),e.push(36,s[this.muff]),e.push(97,s[this.beatsPerBar-1]),e.push(103,s[this.barCount-1>>6],s[this.barCount-1&63]),e.push(106,s[this.patternsPerChannel-1]),e.push(105,s[this.instrumentsPerChannel-1]),e.push(114,s[i.partCounts.indexOf(this.partsPerBeat)]),e.push(111);for(let t=0;t<this.getChannelCount();t++)e.push(s[this.channels[t].octave]);for(let t=0;t<this.getChannelCount();t++)for(let h=0;h<this.instrumentsPerChannel;h++){const n=this.channels[t].instruments[h];if(t<this.pitchChannelCount)if(e.push(84,s[n.type]),0==n.type)e.push(119,s[n.wave]),e.push(102,s[n.filter]),e.push(100,s[n.transition]),e.push(99,s[n.effect]),e.push(113,s[n.harm]),e.push(71,s[n.imute]),e.push(76,s[n.ipan]),e.push(66,s[n.octoff]),e.push(104,s[n.chorus]),e.push(118,s[n.volume]);else if(1==n.type){e.push(100,s[n.transition]),e.push(99,s[n.effect]),e.push(66,s[n.octoff]),e.push(35,s[n.fmChorus]),e.push(71,s[n.imute]),e.push(76,s[n.ipan]),e.push(65,s[n.algorithm]),e.push(70,s[n.feedbackType]),e.push(95,s[n.feedbackAmplitude]),e.push(86,s[n.feedbackEnvelope]),e.push(118,s[n.volume]),e.push(81);for(let t=0;t<i.operatorCount;t++)e.push(s[n.operators[t].frequency]);e.push(80);for(let t=0;t<i.operatorCount;t++)e.push(s[n.operators[t].amplitude]);e.push(69);for(let t=0;t<i.operatorCount;t++)e.push(s[n.operators[t].envelope])}else{if(3!=n.type)throw new Error("Unknown instrument type.");e.push(119,s[n.wave]),e.push(102,s[n.filter]),e.push(100,s[n.transition]),e.push(99,s[n.effect]),e.push(113,s[n.harm]),e.push(71,s[n.imute]),e.push(76,s[n.ipan]),e.push(66,s[n.octoff]),e.push(104,s[n.chorus]),e.push(118,s[n.volume])}else e.push(84,s[2]),e.push(119,s[n.wave]),e.push(100,s[n.transition]),e.push(118,s[n.volume]),e.push(71,s[n.imute]),e.push(113,s[n.harm]),e.push(66,s[n.octoff]),e.push(76,s[n.ipan])}e.push(98),t=new l;let n=0;for(;1<<n<this.patternsPerChannel+1;)n++;for(let e=0;e<this.getChannelCount();e++)for(let s=0;s<this.barCount;s++)t.write(n,this.channels[e].bars[s]);t.encodeBase64(s,e),e.push(112),t=new l;let a=0;for(;1<<a<this.instrumentsPerChannel;)a++;for(let e=0;e<this.getChannelCount();e++){const h=this.getChannelIsDrum(e),i=h?0:12*this.channels[e].octave;let n=(h?4:12)+i;const r=h?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],o=[];for(let t=0;t<r.length;t++)r[t]+=i;for(const h of this.channels[e].patterns)if(t.write(a,h.instrument),h.notes.length>0){t.write(1,1);let e=0;for(const i of h.notes){i.start>e&&(t.write(2,0),t.writePartDuration(i.start-e));const h=new l;for(let t=1;t<i.pitches.length;t++)h.write(1,1);i.pitches.length<4&&h.write(1,0),h.writePinCount(i.pins.length-1),h.write(2,i.pins[0].volume);let a=0,f=i.pitches[0],c=f;const u=[];for(let t=1;t<i.pins.length;t++){const e=i.pins[t],s=f+e.interval;c!=s?(h.write(1,1),u.push(s),c=s):h.write(1,0),h.writePartDuration(e.time-a),a=e.time,h.write(2,e.volume)}const d=String.fromCharCode.apply(null,h.encodeBase64(s,[])),m=o.indexOf(d);-1==m?(t.write(2,1),t.concat(h)):(t.write(1,1),t.writeLongTail(0,0,m),o.splice(m,1)),o.unshift(d),o.length>10&&o.pop();const p=i.pitches.concat(u);for(let e=0;e<p.length;e++){const s=p[e],h=r.indexOf(s);if(-1==h){let e=0,h=n;if(h<s)for(;h!=s;)h++,-1==r.indexOf(h)&&e++;else for(;h!=s;)h--,-1==r.indexOf(h)&&e--;t.write(1,0),t.writePitchInterval(e)}else t.write(1,1),t.write(3,h),r.splice(h,1);r.unshift(s),r.length>8&&r.pop(),n=e==i.pitches.length-1?i.pitches[0]:s}e=i.end}e<this.beatsPerBar*this.partsPerBeat&&(t.write(2,0),t.writePartDuration(this.beatsPerBar*this.partsPerBeat-e))}else t.write(1,0)}let r=t.lengthBase64(),o=[];for(;r>0;)o.unshift(s[63&r]),r>>=6;if(e.push(s[o.length]),Array.prototype.push.apply(e,o),t.encodeBase64(s,e),e.length>=65535)throw new Error("Song hash code too long.");return String.fromCharCode.apply(null,e)}fromBase64String(t){if(null==t||""==t)return void this.initToDefault(!0);let e=0;for(;t.charCodeAt(e)<=32;)e++;if(35==t.charCodeAt(e)&&e++,123==t.charCodeAt(e))return void this.fromJsonObject(JSON.parse(0==e?t:t.substring(e)));let s,h;110==t.charCodeAt(e)?(s=!1,h=!0,e++):(s=!0,h=!1);const n=m.v[t.charCodeAt(e++)];if(s&&(-1==n||n>m.P||n<m.L))return;if(h&&(-1==n||n>m.p||n<m.M))return;const l=n<3,r=n<4,p=n<5,y=n<6,g=m.v;if(this.initToDefault(s&&y||h),s&&l){for(const t of this.channels)t.instruments[0].transition=0;this.channels[3].instruments[0].wave=0}let b=0,v=-1;for(;e<t.length;){const n=t.charCodeAt(e++);let M;if(110==n){this.pitchChannelCount=g[t.charCodeAt(e++)],this.drumChannelCount=g[t.charCodeAt(e++)],this.pitchChannelCount=m.R(i.pitchChannelCountMin,i.pitchChannelCountMax+1,this.pitchChannelCount),this.drumChannelCount=m.R(i.drumChannelCountMin,i.drumChannelCountMax+1,this.drumChannelCount);for(let t=this.channels.length;t<this.getChannelCount();t++)this.channels[t]=new u;this.channels.length=this.getChannelCount()}else if(115==n)this.scale=g[t.charCodeAt(e++)],s&&l&&10==this.scale&&(this.scale=11);else if(117==n)this.mix=g[t.charCodeAt(e++)];else if(107==n)this.key=g[t.charCodeAt(e++)];else if(122==n)if(s){var P=g[t.charCodeAt(e++)];this.setSongTheme=["none","modbox2","artic","Cinnamon Roll","Ocean","rainbow","float","windows","grassland","dessert","kahootiest","beambit","egg","Poniryoshka","gameboy","woodkid","midnight","snedbox","unnamed","piano","halloween","frozen"][P]}else{var L=(g[t.charCodeAt(e++)]<<6)+g[t.charCodeAt(e++)];this.setSongTheme=decodeURIComponent(t.substring(e,e+L)),e+=L}else if(108==n)this.loopStart=s&&p?g[t.charCodeAt(e++)]:(g[t.charCodeAt(e++)]<<6)+g[t.charCodeAt(e++)];else if(101==n)this.loopLength=s&&p?g[t.charCodeAt(e++)]:(g[t.charCodeAt(e++)]<<6)+g[t.charCodeAt(e++)]+1;else if(116==n)this.tempo=s&&r?[1,4,7,10][g[t.charCodeAt(e++)]]:g[t.charCodeAt(e++)],this.tempo=m.R(0,i.tempoSteps,this.tempo);else if(109==n)this.reverb=g[t.charCodeAt(e++)],this.reverb=m.R(0,i.reverbRange,this.reverb);else if(120==n)this.blend=m.R(0,i.blendRange,g[t.charCodeAt(e++)]);else if(121==n)this.riff=m.R(0,i.riffRange,g[t.charCodeAt(e++)]);else if(124==n)this.sampleRate=g[t.charCodeAt(e++)];else if(72==n)this.detune=m.R(0,i.detuneRange,g[t.charCodeAt(e++)]);else if(36==n)this.muff=m.R(0,i.muffRange,g[t.charCodeAt(e++)]);else if(97==n)this.beatsPerBar=s&&l?[6,7,8,9,10][g[t.charCodeAt(e++)]]:g[t.charCodeAt(e++)]+1,this.beatsPerBar=Math.max(i.beatsPerBarMin,Math.min(i.beatsPerBarMax,this.beatsPerBar));else if(103==n){this.barCount=(g[t.charCodeAt(e++)]<<6)+g[t.charCodeAt(e++)]+1,this.barCount=Math.max(i.barCountMin,Math.min(i.barCountMax,this.barCount));for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].bars.length;e<this.barCount;e++)this.channels[t].bars[e]=1;this.channels[t].bars.length=this.barCount}}else if(106==n){this.patternsPerChannel=g[t.charCodeAt(e++)]+1,this.patternsPerChannel=Math.max(1,Math.min(i.barCountMax,this.patternsPerChannel));for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].patterns.length;e<this.patternsPerChannel;e++)this.channels[t].patterns[e]=new d;this.channels[t].patterns.length=this.patternsPerChannel}}else if(105==n){this.instrumentsPerChannel=g[t.charCodeAt(e++)]+1,this.instrumentsPerChannel=Math.max(i.instrumentsPerChannelMin,Math.min(i.instrumentsPerChannelMax,this.instrumentsPerChannel));for(let t=0;t<this.getChannelCount();t++){for(let e=this.channels[t].instruments.length;e<this.instrumentsPerChannel;e++)this.channels[t].instruments[e]=new c;this.channels[t].instruments.length=this.instrumentsPerChannel}}else if(114==n)this.partsPerBeat=i.partCounts[g[t.charCodeAt(e++)]];else if(111==n)if(s&&l)M=g[t.charCodeAt(e++)],this.channels[M].octave=m.R(0,5,g[t.charCodeAt(e++)]);else for(M=0;M<this.getChannelCount();M++)this.channels[M].octave=m.R(0,5,g[t.charCodeAt(e++)]);else if(84==n){v++,v>=this.instrumentsPerChannel&&(b++,v=0);const s=b<this.pitchChannelCount,h=this.channels[b].instruments[v];let i=m.R(0,4,g[t.charCodeAt(e++)]);2==i&&s&&(i=3),h.setTypeAndReset(i)}else if(119==n)if(s&&l)M=g[t.charCodeAt(e++)],this.channels[M].instruments[0].wave=m.R(0,i.waveNames.length,g[t.charCodeAt(e++)]);else if(s&&y)for(M=0;M<this.getChannelCount();M++){const s=M>=this.pitchChannelCount;for(let h=0;h<this.instrumentsPerChannel;h++)this.channels[M].instruments[h].wave=m.R(0,s?i.drumNames.length:i.waveNames.length,g[t.charCodeAt(e++)])}else{const s=b>=this.pitchChannelCount;this.channels[b].instruments[v].wave=m.R(0,s?i.drumNames.length:i.waveNames.length,g[t.charCodeAt(e++)])}else if(102==n)if(s&&l)M=g[t.charCodeAt(e++)],this.channels[M].instruments[0].filter=[1,3,4,5][m.R(0,i.filterNames.length,g[t.charCodeAt(e++)])];else if(s&&y)for(M=0;M<this.getChannelCount();M++)for(let s=0;s<this.instrumentsPerChannel;s++)this.channels[M].instruments[s].filter=m.R(0,i.filterNames.length,g[t.charCodeAt(e++)]+1);else this.channels[b].instruments[v].filter=m.R(0,i.filterNames.length,g[t.charCodeAt(e++)]);else if(100==n)if(s&&l)M=g[t.charCodeAt(e++)],this.channels[M].instruments[0].transition=m.R(0,i.transitionNames.length,g[t.charCodeAt(e++)]);else if(s&&y)for(M=0;M<this.getChannelCount();M++)for(let s=0;s<this.instrumentsPerChannel;s++)this.channels[M].instruments[s].transition=m.R(0,i.transitionNames.length,g[t.charCodeAt(e++)]);else this.channels[b].instruments[v].transition=m.R(0,i.transitionNames.length,g[t.charCodeAt(e++)]);else if(99==n)if(s&&l){M=g[t.charCodeAt(e++)];let s=m.R(0,i.effectNames.length,g[t.charCodeAt(e++)]);1==s?s=3:3==s&&(s=5),this.channels[M].instruments[0].effect=s}else if(s&&y)for(M=0;M<this.getChannelCount();M++)for(let s=0;s<this.instrumentsPerChannel;s++)this.channels[M].instruments[s].effect=m.R(0,i.effectNames.length,g[t.charCodeAt(e++)]);else this.channels[b].instruments[v].effect=m.R(0,i.effectNames.length,g[t.charCodeAt(e++)]);else if(104==n)if(s&&l)M=g[t.charCodeAt(e++)],this.channels[M].instruments[0].chorus=m.R(0,i.chorusNames.length,g[t.charCodeAt(e++)]);else if(s&&y)for(M=0;M<this.getChannelCount();M++)for(let s=0;s<this.instrumentsPerChannel;s++)this.channels[M].instruments[s].chorus=m.R(0,i.chorusNames.length,g[t.charCodeAt(e++)]);else this.channels[b].instruments[v].chorus=m.R(0,i.chorusNames.length,g[t.charCodeAt(e++)]);else if(113==n)if(s&&y)for(M=0;M<this.getChannelCount();M++)for(let s=0;s<this.instrumentsPerChannel;s++)this.channels[M].instruments[s].harm=m.R(0,i.harmNames.length,g[t.charCodeAt(e++)]);else this.channels[b].instruments[v].harm=m.R(0,i.harmNames.length,g[t.charCodeAt(e++)]);else if(35==n)this.channels[b].instruments[v].fmChorus=m.R(0,i.fmChorusNames.length,g[t.charCodeAt(e++)]);else if(71==n)this.channels[b].instruments[v].imute=m.R(0,i.imuteNames.length,g[t.charCodeAt(e++)]);else if(76==n)this.channels[b].instruments[v].ipan=m.R(0,i.ipanValues.length,g[t.charCodeAt(e++)]);else if(66==n)if(s&&y)for(M=0;M<this.getChannelCount();M++)for(let s=0;s<this.instrumentsPerChannel;s++)this.channels[M].instruments[s].octoff=m.R(0,i.octoffNames.length,g[t.charCodeAt(e++)]);else this.channels[b].instruments[v].octoff=m.R(0,i.octoffNames.length,g[t.charCodeAt(e++)]);else if(118==n)if(s&&l)M=g[t.charCodeAt(e++)],this.channels[M].instruments[0].volume=m.R(0,i.volumeNames.length,g[t.charCodeAt(e++)]);else if(s&&y)for(M=0;M<this.getChannelCount();M++)for(let s=0;s<this.instrumentsPerChannel;s++)this.channels[M].instruments[s].volume=m.R(0,i.volumeNames.length,g[t.charCodeAt(e++)]);else this.channels[b].instruments[v].volume=m.R(0,i.volumeNames.length,g[t.charCodeAt(e++)]);else if(65==n)this.channels[b].instruments[v].algorithm=m.R(0,i.operatorAlgorithmNames.length,g[t.charCodeAt(e++)]);else if(70==n)this.channels[b].instruments[v].feedbackType=m.R(0,i.operatorFeedbackNames.length,g[t.charCodeAt(e++)]);else if(95==n)this.channels[b].instruments[v].feedbackAmplitude=m.R(0,i.operatorAmplitudeMax+1,g[t.charCodeAt(e++)]);else if(86==n)this.channels[b].instruments[v].feedbackEnvelope=m.R(0,i.operatorEnvelopeNames.length,g[t.charCodeAt(e++)]);else if(81==n)for(let s=0;s<i.operatorCount;s++)this.channels[b].instruments[v].operators[s].frequency=m.R(0,i.operatorFrequencyNames.length,g[t.charCodeAt(e++)]);else if(80==n)for(let s=0;s<i.operatorCount;s++)this.channels[b].instruments[v].operators[s].amplitude=m.R(0,i.operatorAmplitudeMax+1,g[t.charCodeAt(e++)]);else if(69==n)for(let s=0;s<i.operatorCount;s++)this.channels[b].instruments[v].operators[s].envelope=m.R(0,i.operatorEnvelopeNames.length,g[t.charCodeAt(e++)]);else if(98==n){let h;if(s&&l){M=g[t.charCodeAt(e++)];const s=g[t.charCodeAt(e++)];h=Math.ceil(.5*s);const i=new a(g,t,e,e+h);for(let t=0;t<s;t++)this.channels[M].bars[t]=i.read(3)+1}else if(s&&p){let s=0;for(;1<<s<this.patternsPerChannel;)s++;h=Math.ceil(this.getChannelCount()*this.barCount*s/6);const i=new a(g,t,e,e+h);for(M=0;M<this.getChannelCount();M++)for(let t=0;t<this.barCount;t++)this.channels[M].bars[t]=i.read(s)+1}else{let s=0;for(;1<<s<this.patternsPerChannel+1;)s++;h=Math.ceil(this.getChannelCount()*this.barCount*s/6);const i=new a(g,t,e,e+h);for(M=0;M<this.getChannelCount();M++)for(let t=0;t<this.barCount;t++)this.channels[M].bars[t]=i.read(s)}e+=h}else if(112==n){let i=0;if(s&&l)M=g[t.charCodeAt(e++)],e++,i=g[t.charCodeAt(e++)],i<<=6,i+=g[t.charCodeAt(e++)];else{M=0;let s=g[t.charCodeAt(e++)];for(;s>0;)i<<=6,i+=g[t.charCodeAt(e++)],s--}const n=new a(g,t,e,e+i);e+=i;let r=0;for(;1<<r<this.instrumentsPerChannel;)r++;for(;;){const t=this.getChannelIsDrum(M),e=t?0:12*this.channels[M].octave;let i=null,a=null,c=(t?4:12)+e;const u=t?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],d=[];for(let t=0;t<u.length;t++)u[t]+=e;for(let t=0;t<this.patternsPerChannel;t++){const e=this.channels[M].patterns[t];if(e.reset(),e.instrument=n.read(r),(s&&!l||h)&&0==n.read(1))continue;let m=0;const p=e.notes;for(;m<this.beatsPerBar*this.partsPerBeat;){const t=1==n.read(1);let e=!1,s=0;if(t?s=n.readLongTail(0,0):e=1==n.read(1),t||e){let e,h,l;if(t)e=d[s],d.splice(s,1);else{for(e={},e.pitchCount=1;e.pitchCount<4&&1==n.read(1);)e.pitchCount++;e.pinCount=n.readPinCount(),e.initialVolume=n.read(2),e.pins=[],e.length=0,e.bendCount=0;for(let t=0;t<e.pinCount;t++)h={},h.pitchBend=1==n.read(1),h.pitchBend&&e.bendCount++,e.length+=n.readPartDuration(),h.time=e.length,h.volume=n.read(2),e.pins.push(h)}d.unshift(e),d.length>10&&d.pop(),i=f(0,m,m+e.length,e.initialVolume),i.pitches=[],i.pins.length=1;const r=[];for(let t=0;t<e.pitchCount+e.bendCount;t++){if(1==n.read(1)){const t=n.read(3);l=u[t],u.splice(t,1)}else{l=c;let t=n.readPitchInterval();for(;t>0;){for(l++;-1!=u.indexOf(l);)l++;t--}for(;t<0;){for(l--;-1!=u.indexOf(l);)l--;t++}}u.unshift(l),u.length>8&&u.pop(),t<e.pitchCount?i.pitches.push(l):r.push(l),c=t==e.pitchCount-1?i.pitches[0]:l}r.unshift(i.pitches[0]);for(const t of e.pins)t.pitchBend&&r.shift(),a=o(r[0]-i.pitches[0],t.time,t.volume),i.pins.push(a);m=i.end,p.push(i)}else{m+=n.readPartDuration()}}}if(s&&l)break;if(M++,M>=this.getChannelCount())break}}}}toJsonObject(t=!0,e=1,s=!0){const h=[];for(let n=0;n<this.getChannelCount();n++){const a=[],l=this.getChannelIsDrum(n);for(let t=0;t<this.instrumentsPerChannel;t++){const e=this.channels[n].instruments[t];if(l)a.push({type:i.instrumentTypeNames[2],volume:20*(5-e.volume),imute:i.imuteNames[e.imute],wave:i.drumNames[e.wave],transition:i.transitionNames[e.transition],octoff:i.octoffNames[e.octoff],ipan:i.ipanValues[e.ipan]});else if(0==e.type)a.push({type:i.instrumentTypeNames[e.type],volume:20*(5-e.volume),wave:i.waveNames[e.wave],transition:i.transitionNames[e.transition],filter:i.filterNames[e.filter],chorus:i.chorusNames[e.chorus],effect:i.effectNames[e.effect],harm:i.harmNames[e.harm],imute:i.imuteNames[e.imute],octoff:i.octoffNames[e.octoff],ipan:i.ipanValues[e.ipan]});else if(1==e.type){const t=[];for(const s of e.operators)t.push({frequency:i.operatorFrequencyNames[s.frequency],amplitude:s.amplitude,envelope:i.operatorEnvelopeNames[s.envelope]});a.push({type:i.instrumentTypeNames[e.type],volume:20*(5-e.volume),transition:i.transitionNames[e.transition],effect:i.effectNames[e.effect],octoff:i.octoffNames[e.octoff],fmChorus:i.fmChorusNames[e.fmChorus],algorithm:i.operatorAlgorithmNames[e.algorithm],feedbackType:i.operatorFeedbackNames[e.feedbackType],feedbackAmplitude:e.feedbackAmplitude,feedbackEnvelope:i.operatorEnvelopeNames[e.feedbackEnvelope],operators:t,ipan:i.ipanValues[e.ipan],imute:i.imuteNames[e.imute]})}else{if(3!=e.type)throw new Error("Unrecognized instrument type");a.push({type:i.instrumentTypeNames[2],volume:20*(5-e.volume),wave:i.pwmwaveNames[e.wave],transition:i.transitionNames[e.transition],filter:i.filterNames[e.filter],chorus:i.chorusNames[e.chorus],effect:i.effectNames[e.effect],harm:i.harmNames[e.harm],imute:i.imuteNames[e.imute],octoff:i.octoffNames[e.octoff],ipan:i.ipanValues[e.ipan]})}}const r=[];for(const t of this.channels[n].patterns){const e=[];for(const s of t.notes){const t=[];for(const e of s.pins)t.push({tick:e.time+s.start,pitchBend:e.interval,volume:Math.round(100*e.volume/3)});e.push({pitches:s.pitches,points:t})}r.push({instrument:t.instrument+1,notes:e})}const o=[];if(t)for(let t=0;t<this.loopStart;t++)o.push(this.channels[n].bars[t]);for(let t=0;t<e;t++)for(let t=this.loopStart;t<this.loopStart+this.loopLength;t++)o.push(this.channels[n].bars[t]);if(s)for(let t=this.loopStart+this.loopLength;t<this.barCount;t++)o.push(this.channels[n].bars[t]);h.push({type:l?"drum":"pitch",octaveScrollBar:this.channels[n].octave,instruments:a,patterns:r,sequence:o})}return{format:m.C,version:m.p,theme:this.setSongTheme,scale:i.scales[this.scale].name,mix:i.mixNames[this.mix],sampleRate:i.sampleRateNames[this.sampleRate],key:i.keys[this.key].name,introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beatsPerBar,ticksPerBeat:this.partsPerBeat,beatsPerMinute:this.getBeatsPerMinute(),reverb:this.reverb,blend:this.blend,riff:this.riff,detune:this.detune,muff:this.muff,channels:h}}fromJsonObject(t){if(this.initToDefault(!0),!t)return;const e=t.format;if(t.version>m.C)return;if(this.scale=11,null!=t.scale)if("BeepBox"==e){const e={"romani :)":8,"romani :(":9},s=null!=e[t.scale]?e[t.scale]:i.scales.map((t=>t.name)).indexOf(t.scale);-1!=s&&(this.scale=s)}else this.scale=i.scales.map((t=>t.name)).indexOf(t.scale);if(null!=t.theme)if("BeepBox"==e)if("Nepbox"!=t.theme&&"Laffey"!=t.theme&&"ModBox"!=t.theme){var s=["none","modbox2","artic","Cinnamon Roll","Ocean","rainbow","float","windows","grassland","dessert","kahootiest","beambit","egg","Poniryoshka","gameboy","woodkid","midnight","snedbox","unnamed","piano","halloween","frozen"],h=i.oldThemeNames.indexOf(t.theme);this.setSongTheme=s[h]}else{s=["none","nepbox","laffey"],h=["ModBox","Nepbox","Laffey"].indexOf(t.theme);this.setSongTheme=s[h]}else this.setSongTheme=t.theme;if(null!=t.mix&&(this.mix=i.mixNames.indexOf(t.mix),-1==this.mix&&(this.mix=1)),null!=t.sampleRate&&(this.sampleRate=i.sampleRateNames.indexOf(t.sampleRate),-1==this.sampleRate&&(this.sampleRate=2)),null!=t.key&&("BeepBox"==e?"number"==typeof t.key?this.key=i.oldKeys.length-1-(t.key+1200>>>0)%i.oldKeys.length:"string"==typeof t.key&&(this.key=i.keys.map((t=>t.name)).indexOf(t.key)):this.key=i.keys.map((t=>t.name)).indexOf(t.key)),null!=t.beatsPerMinute){const e=0|t.beatsPerMinute;this.tempo=Math.round(4+9*Math.log(e/120)/Math.LN2),this.tempo=m.R(0,i.tempoSteps,this.tempo)}null!=t.reverb&&(this.reverb=m.R(0,i.reverbRange,0|t.reverb)),null!=t.blend&&(this.blend=m.R(0,i.blendRange,0|t.blend)),null!=t.riff&&(this.riff=m.R(0,i.riffRange,0|t.riff)),null!=t.detune&&(this.detune=m.R(0,i.detuneRange,0|t.detune)),null!=t.muff&&(this.muff=m.R(0,i.muffRange,0|t.muff)),null!=t.beatsPerBar&&(this.beatsPerBar=Math.max(i.beatsPerBarMin,Math.min(i.beatsPerBarMax,0|t.beatsPerBar))),null!=t.ticksPerBeat&&(this.partsPerBeat=0|t.ticksPerBeat,-1==i.partCounts.indexOf(this.partsPerBeat)&&(this.partsPerBeat=i.partCounts[i.partCounts.length-1]));let n=1,a=1,l=1;if(t.channels)for(const e of t.channels)e.instruments&&(n=Math.max(n,0|e.instruments.length)),e.patterns&&(a=Math.max(a,0|e.patterns.length)),e.sequence&&(l=Math.max(l,0|e.sequence.length));this.instrumentsPerChannel=n,this.patternsPerChannel=a,this.barCount=l,null!=t.introBars&&(this.loopStart=m.R(0,this.barCount,0|t.introBars)),null!=t.loopBars&&(this.loopLength=m.R(1,this.barCount-this.loopStart+1,0|t.loopBars));let r=0,p=0;if(t.channels)for(let e=0;e<t.channels.length;e++){let s=t.channels[e];this.channels.length<=e&&(this.channels[e]=new u),null!=s.octaveScrollBar&&(this.channels[e].octave=m.R(0,5,0|s.octaveScrollBar));for(let t=this.channels[e].instruments.length;t<this.instrumentsPerChannel;t++)this.channels[e].instruments[t]=new c;this.channels[e].instruments.length=this.instrumentsPerChannel;for(let t=this.channels[e].patterns.length;t<this.patternsPerChannel;t++)this.channels[e].patterns[t]=new d;this.channels[e].patterns.length=this.patternsPerChannel;for(let t=0;t<this.barCount;t++)this.channels[e].bars[t]=1;this.channels[e].bars.length=this.barCount;let h=!1;h=s.type?"drum"==s.type:e>=3,h?p++:r++;for(let t=0;t<this.instrumentsPerChannel;t++){const n=this.channels[e].instruments[t];let a;s.instruments&&(a=s.instruments[t]),null==a&&(a={});const l={binary:0},r=a.transition||a.envelope;if(n.transition=null!=l[r]?l[r]:i.transitionNames.indexOf(r),-1==n.transition&&(n.transition=1),h)null!=a.volume?n.volume=m.R(0,i.volumeNames.length,Math.round(5-(0|a.volume)/20)):n.volume=0,n.wave=i.drumNames.indexOf(a.wave),-1==n.wave&&(n.wave=1),n.imute=i.imuteNames.indexOf(a.imute),-1==n.imute&&(n.imute=0),n.ipan=i.ipanValues.indexOf(a.ipan),-1==n.ipan&&(n.ipan=4);else if(n.type=i.instrumentTypeNames.indexOf(a.type),null==n.type&&(n.type=0),0==n.type){null!=a.volume?n.volume=m.R(0,i.volumeNames.length,Math.round(5-(0|a.volume)/20)):n.volume=0,n.wave=i.waveNames.indexOf(a.wave),-1==n.wave&&(n.wave=1);const t={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};n.filter=null!=t[a.filter]?t[a.filter]:i.filterNames.indexOf(a.filter),-1==n.filter&&(n.filter=0),n.chorus=i.chorusNames.indexOf(a.chorus),-1==n.chorus&&(n.chorus=0),n.effect=i.effectNames.indexOf(a.effect),-1==n.effect&&(n.effect=0),n.harm=i.harmNames.indexOf(a.harm),-1==n.harm&&(n.harm=0),n.octoff=i.octoffNames.indexOf(a.octoff),-1==n.octoff&&(n.octoff=0),n.imute=i.imuteNames.indexOf(a.imute),-1==n.imute&&(n.imute=0),n.ipan=i.ipanValues.indexOf(a.ipan),-1==n.ipan&&(n.ipan=4)}else if(3==n.type||2==n.type){2==n.type&&(n.type=3),null!=a.volume?n.volume=m.R(0,i.volumeNames.length,Math.round(5-(0|a.volume)/20)):n.volume=0,n.wave=i.pwmwaveNames.indexOf(a.wave),-1==n.wave&&(n.wave=1);const t={"sustain sharp":1,"sustain medium":2,"sustain soft":3,"decay sharp":4};n.filter=null!=t[a.filter]?t[a.filter]:i.filterNames.indexOf(a.filter),-1==n.filter&&(n.filter=0),n.chorus=i.chorusNames.indexOf(a.chorus),-1==n.chorus&&(n.chorus=0),n.effect=i.effectNames.indexOf(a.effect),-1==n.effect&&(n.effect=0),n.harm=i.harmNames.indexOf(a.harm),-1==n.harm&&(n.harm=0),n.octoff=i.octoffNames.indexOf(a.octoff),-1==n.octoff&&(n.octoff=0),n.imute=i.imuteNames.indexOf(a.imute),-1==n.imute&&(n.imute=0),n.ipan=i.ipanValues.indexOf(a.ipan),-1==n.ipan&&(n.ipan=4)}else{if(1!=n.type)throw new Error("Unrecognized instrument type.");n.effect=i.effectNames.indexOf(a.effect),-1==n.effect&&(n.effect=0),n.octoff=i.octoffNames.indexOf(a.octoff),-1==n.octoff&&(n.octoff=0),n.fmChorus=i.fmChorusNames.indexOf(a.fmChorus),-1==n.fmChorus&&(n.fmChorus=0),n.algorithm=i.operatorAlgorithmNames.indexOf(a.algorithm),-1==n.algorithm&&(n.algorithm=0),n.feedbackType=i.operatorFeedbackNames.indexOf(a.feedbackType),-1==n.feedbackType&&(n.feedbackType=0),null!=a.feedbackAmplitude?n.feedbackAmplitude=m.R(0,i.operatorAmplitudeMax+1,0|a.feedbackAmplitude):n.feedbackAmplitude=0,n.feedbackEnvelope=i.operatorEnvelopeNames.indexOf(a.feedbackEnvelope),-1==n.feedbackEnvelope&&(n.feedbackEnvelope=0);for(let t=0;t<i.operatorCount;t++){const e=n.operators[t];let s;a.operators&&(s=a.operators[t]),null==s&&(s={}),e.frequency=i.operatorFrequencyNames.indexOf(s.frequency),-1==e.frequency&&(e.frequency=0),null!=s.amplitude?e.amplitude=m.R(0,i.operatorAmplitudeMax+1,0|s.amplitude):e.amplitude=0,e.envelope=i.operatorEnvelopeNames.indexOf(s.envelope),-1==e.envelope&&(e.envelope=0)}n.ipan=i.ipanValues.indexOf(a.ipan),-1==n.ipan&&(n.ipan=4),n.imute=i.imuteNames.indexOf(a.imute),-1==n.imute&&(n.imute=0)}}for(let t=0;t<this.patternsPerChannel;t++){const n=this.channels[e].patterns[t];let a;if(s.patterns&&(a=s.patterns[t]),null!=a&&(n.instrument=m.R(0,this.instrumentsPerChannel,(0|a.instrument)-1),a.notes&&a.notes.length>0)){const t=Math.min(this.beatsPerBar*this.partsPerBeat,a.notes.length>>>0);let e=0;for(let s=0;s<a.notes.length&&!(s>=t);s++){const t=a.notes[s];if(!(t&&t.pitches&&t.pitches.length>=1&&t.points&&t.points.length>=2))continue;const l=f(0,0,0,0);l.pitches=[],l.pins=[];for(let e=0;e<t.pitches.length;e++){const s=0|t.pitches[e];if(-1==l.pitches.indexOf(s)&&(l.pitches.push(s),l.pitches.length>=4))break}if(l.pitches.length<1)continue;let r=e,c=0;for(let e=0;e<t.points.length;e++){const s=t.points[e];if(null==s||null==s.tick)continue;const h=null==s.pitchBend?0:0|s.pitchBend,i=0|s.tick,n=null==s.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|s.volume)/100)));if(!(i>this.beatsPerBar*this.partsPerBeat)){if(0==l.pins.length){if(i<r)continue;l.start=i,c=h}else if(i<=r)continue;r=i,l.pins.push(o(h-c,i-l.start,n))}}if(l.pins.length<2)continue;l.end=l.pins[l.pins.length-1].time+l.start;const u=h?i.drumCount-1:i.maxPitch;let d=u,m=0;for(let t=0;t<l.pitches.length;t++)l.pitches[t]+=c,(l.pitches[t]<0||l.pitches[t]>u)&&(l.pitches.splice(t,1),t--),l.pitches[t]<d&&(d=l.pitches[t]),l.pitches[t]>m&&(m=l.pitches[t]);if(!(l.pitches.length<1)){for(let t=0;t<l.pins.length;t++){const e=l.pins[t];e.interval+d<0&&(e.interval=-d),e.interval+m>u&&(e.interval=u-m),t>=2&&e.interval==l.pins[t-1].interval&&e.interval==l.pins[t-2].interval&&e.volume==l.pins[t-1].volume&&e.volume==l.pins[t-2].volume&&(l.pins.splice(t-1,1),t--)}n.notes.push(l),e=l.end}}}}for(let t=0;t<this.barCount;t++)this.channels[e].bars[t]=s.sequence?Math.min(this.patternsPerChannel,s.sequence[t]>>>0):0}this.pitchChannelCount=r,this.drumChannelCount=p,this.channels.length=this.getChannelCount()}static R(t,e,s){return s<=(e-=1)?s>=t?s:t:e}getPattern(t,e){const s=this.channels[t].bars[e];return 0==s?null:this.channels[t].patterns[s-1]}getPatternInstrument(t,e){const s=this.getPattern(t,e);return null==s?0:s.instrument}getPatternInstrumentMute(t,e){const s=this.getPattern(t,e),h=this.getPatternInstrument(t,e),i=this.channels[t].instruments[h];return null==s?0:i.imute}getPatternInstrumentVolume(t,e){const s=this.getPattern(t,e),h=this.getPatternInstrument(t,e),i=this.channels[t].instruments[h];return null==s?0:i.volume}getBeatsPerMinute(){return Math.round(120*Math.pow(2,(-4+this.tempo)/9))}getChannelFingerprint(t){const e=this.getChannelCount();let s=0;for(let h=0;h<e;h++)if(h<this.pitchChannelCount){const e=this.getPatternInstrument(h,t),i=this.channels[h].instruments[e];if(0==i.type)this.o[s++]="c";else if(1==i.type)this.o[s++]="f",this.o[s++]=i.algorithm,this.o[s++]=i.feedbackType;else{if(3!=i.type)throw new Error("Unknown instrument type.");this.o[s++]="p"}}else this.o[s++]="d";return this.o.length=s,this.o.join("")}}m.C="NepBox",m.L=2,m.P=6,m.M=1,m.p=1,m.m=110,m.v=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0],m.u=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95];class p{constructor(){this.sampleLeft=0,this.sampleRight=0,this.phases=[],this.phaseDeltas=[],this.volumeStarts=[],this.volumeDeltas=[],this.volumeLeft=[],this.volumeRight=[],this.phaseDeltaScale=0,this.filter=0,this.filterScale=0,this.vibratoScale=0,this.harmonyMult=0,this.harmonyVolumeMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.reset()}reset(){for(let t=0;t<i.operatorCount;t++)this.phases[t]=0,this.feedbackOutputs[t]=0;this.sampleLeft=0,this.sampleRight=0}}class y{static warmUpSynthesizer(t){if(null!=t){for(let e=0;e<t.instrumentsPerChannel;e++)for(let s=t.pitchChannelCount;s<t.pitchChannelCount+t.drumChannelCount;s++)i.getDrumWave(t.channels[s].instruments[e].wave);for(let e=0;e<t.barCount;e++)y.getGeneratedSynthesizer(t,e)}}static operatorAmplitudeCurve(t){return(Math.pow(16,t/15)-1)/15}get playing(){return this.isPlaying}get playhead(){return this.playheadInternal}set playhead(t){if(null!=this.song){this.playheadInternal=Math.max(0,Math.min(this.song.barCount,t));let e=this.playheadInternal;this.bar=Math.floor(e),e=this.song.beatsPerBar*(e-this.bar),this.beat=Math.floor(e),e=this.song.partsPerBeat*(e-this.beat),this.part=Math.floor(e),e=4*(e-this.part),this.arpeggio=Math.floor(e);const s=this.getSamplesPerArpeggio();e=s*(e-this.arpeggio),this.arpSampleCountdown=Math.floor(s-e),this.bar<this.song.loopStart&&(this.enableIntro=!0),this.bar>this.song.loopStart+this.song.loopLength&&(this.enableOutro=!0)}}get totalSamples(){if(null==this.song)return 0;const t=4*this.getSamplesPerArpeggio()*this.song.partsPerBeat*this.song.beatsPerBar;let e=this.loopCount;e<0&&(e=1);let s=this.song.loopLength*e;return this.enableIntro&&(s+=this.song.loopStart),this.enableOutro&&(s+=this.song.barCount-(this.song.loopStart+this.song.loopLength)),s*t}get totalSeconds(){return Math.round(this.totalSamples/this.samplesPerSecond)}get totalBars(){return null==this.song?0:this.song.barCount}constructor(t=null){this.samplesPerSecond=44100,this.effectDuration=.14,this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond),this.song=null,this.pianoPressed=!1,this.pianoPitch=[0],this.pianoChannel=0,this.enableIntro=!0,this.enableOutro=!1,this.loopCount=-1,this.volume=1,this.liveInputDuration=0,this.liveInputStarted=!1,this.liveInputPitches=[],this.liveInputChannel=0,this.playheadInternal=0,this.bar=0,this.beat=0,this.part=0,this.arpeggio=0,this.arpSampleCountdown=0,this.isPlaying=!1,this.liveInputEndTime=0,this.browserAutomaticallyClearsAudioBuffer=!0,this.channels=[],this.stillGoing=!1,this.effectPhase=0,this.limit=0,this.delayLineLeft=new Float32Array(16384),this.delayLineRight=new Float32Array(16384),this.delayPosLeft=0,this.delayPosRight=0,this.delayFeedback0Left=0,this.delayFeedback0Right=0,this.delayFeedback1Left=0,this.delayFeedback1Right=0,this.delayFeedback2Left=0,this.delayFeedback2Right=0,this.delayFeedback3Left=0,this.delayFeedback3Right=0,this.audioCtx=null,this.scriptNode=null,this.audioProcessCallback=t=>{const e=t.outputBuffer,s=e.getChannelData(0),h=e.getChannelData(1);if(!this.browserAutomaticallyClearsAudioBuffer||0==s[0]&&0==h[0]&&0==s[e.length-1]&&0==h[e.length-1]||(this.browserAutomaticallyClearsAudioBuffer=!1),!this.browserAutomaticallyClearsAudioBuffer){const t=e.length;for(let e=0;e<t;e++)s[e]=0,h[e]=0}!this.isPlaying&&performance.now()>=this.liveInputEndTime?this.deactivateAudio():this.synthesize(s,h,e.length,this.isPlaying)},null!=t&&this.setSong(t)}setSong(t){"string"==typeof t?this.song=new m(t):t instanceof m&&(this.song=t)}spsCalc(){return y.warmUpSynthesizer(this.song),0==this.song.sampleRate?44100:1==this.song.sampleRate?48e3:2==this.song.sampleRate?this.audioCtx.sampleRate:3==this.song.sampleRate?4*this.audioCtx.sampleRate:4==this.song.sampleRate?2*this.audioCtx.sampleRate:5==this.song.sampleRate?this.audioCtx.sampleRate/2:6==this.song.sampleRate?this.audioCtx.sampleRate/4:7==this.song.sampleRate?this.audioCtx.sampleRate/8:8==this.song.sampleRate?this.audioCtx.sampleRate/16:this.audioCtx.sampleRate}activateAudio(){null!=this.audioCtx&&null!=this.scriptNode||(null!=this.scriptNode&&this.deactivateAudio(),this.audioCtx=this.audioCtx||new(window.AudioContext||window.webkitAudioContext),this.samplesPerSecond=this.spsCalc(),this.scriptNode=this.audioCtx.createScriptProcessor?this.audioCtx.createScriptProcessor(2048,0,2):this.audioCtx.createJavaScriptNode(2048,0,2),this.scriptNode.onaudioprocess=this.audioProcessCallback,this.scriptNode.channelCountMode="explicit",this.scriptNode.channelInterpretation="speakers",this.effectAngle=2*Math.PI/(this.effectDuration*this.samplesPerSecond),this.effectYMult=2*Math.cos(this.effectAngle),this.limitDecay=1/(2*this.samplesPerSecond),this.scriptNode.connect(this.audioCtx.destination)),this.audioCtx.resume()}deactivateAudio(){null!=this.audioCtx&&null!=this.scriptNode&&(this.scriptNode.disconnect(this.audioCtx.destination),this.scriptNode=null,this.audioCtx.close&&this.audioCtx.close(),this.audioCtx=null)}maintainLiveInput(){this.activateAudio(),this.liveInputEndTime=performance.now()+1e4}play(){this.isPlaying||(this.isPlaying=!0,y.warmUpSynthesizer(this.song),this.activateAudio())}pause(){this.isPlaying&&(this.isPlaying=!1,this.deactivateAudio(),this.scriptNode=null)}snapToStart(){this.bar=0,this.enableIntro=!0,this.snapToBar()}snapToBar(t){void 0!==t&&(this.bar=t),this.playheadInternal=this.bar,this.beat=0,this.part=0,this.arpeggio=0,this.arpSampleCountdown=0,this.effectPhase=0;for(const t of this.channels)t.reset();this.delayPosLeft=0,this.delayPosRight=0,this.delayFeedback0Left=0,this.delayFeedback0Right=0,this.delayFeedback1Left=0,this.delayFeedback1Right=0,this.delayFeedback2Left=0,this.delayFeedback2Right=0,this.delayFeedback3Left=0,this.delayFeedback3Right=0;for(let t=0;t<this.delayLineLeft.length;t++)this.delayLineLeft[t]=0;for(let t=0;t<this.delayLineRight.length;t++)this.delayLineRight[t]=0}nextBar(){if(!this.song)return;const t=this.bar;this.bar++,this.enableOutro?this.bar>=this.song.barCount&&(this.bar=this.enableIntro?0:this.song.loopStart):(this.bar>=this.song.loopStart+this.song.loopLength||this.bar>=this.song.barCount)&&(this.bar=this.song.loopStart),this.playheadInternal+=this.bar-t}prevBar(){if(!this.song)return;const t=this.bar;this.bar--,this.bar<0&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.bar>=this.song.barCount&&(this.bar=this.song.barCount-1),this.bar<this.song.loopStart&&(this.enableIntro=!0),!this.enableOutro&&this.bar>=this.song.loopStart+this.song.loopLength&&(this.bar=this.song.loopStart+this.song.loopLength-1),this.playheadInternal+=this.bar-t}synthesize(t,e,s,h=!0){if(null==this.song){for(let h=0;h<s;h++)t[h]=0,e[h]=0;return void this.deactivateAudio()}const i=this.song.getChannelCount();for(let t=this.channels.length;t<i;t++)this.channels[t]=new p;this.channels.length=i;const n=this.getSamplesPerArpeggio();let a=0,l=!1;for((0==this.arpSampleCountdown||this.arpSampleCountdown>n)&&(this.arpSampleCountdown=n),h&&(this.part>=this.song.partsPerBeat&&(this.beat++,this.part=0,this.arpeggio=0,this.arpSampleCountdown=n),this.beat>=this.song.beatsPerBar&&(this.bar++,this.beat=0,this.part=0,this.arpeggio=0,this.arpSampleCountdown=n,-1==this.loopCount&&(this.bar<this.song.loopStart&&!this.enableIntro&&(this.bar=this.song.loopStart),this.bar>=this.song.loopStart+this.song.loopLength&&!this.enableOutro&&(this.bar=this.song.loopStart))),this.bar>=this.song.barCount&&(this.enableOutro?(this.bar=0,this.enableIntro=!0,l=!0,this.pause()):this.bar=this.song.loopStart),this.bar>=this.song.loopStart&&(this.enableIntro=!1));;){if(l){for(;a<s;)t[a]=0,e[a]=0,a++;break}a=y.getGeneratedSynthesizer(this.song,this.bar)(this,this.song,t,e,s,a,n);if(-1==a)break;this.beat=0,this.effectPhase=0,this.bar++,this.bar<this.song.loopStart?this.enableIntro||(this.bar=this.song.loopStart):this.enableIntro=!1,this.bar>=this.song.loopStart+this.song.loopLength&&(this.loopCount>0&&this.loopCount--,(this.loopCount>0||!this.enableOutro)&&(this.bar=this.song.loopStart)),this.bar>=this.song.barCount&&(this.bar=0,this.enableIntro=!0,l=!0,this.pause())}this.playheadInternal=(((this.arpeggio+1-this.arpSampleCountdown/n)/4+this.part)/this.song.partsPerBeat+this.beat)/this.song.beatsPerBar+this.bar}static computeOperatorEnvelope(t,e,s,h){switch(i.operatorEnvelopeType[t]){case 0:return h;case 1:return 1;case 4:let n=1/(1+e*i.operatorEnvelopeSpeed[t]);return i.operatorEnvelopeInverted[t]?1-n:n;case 5:return i.operatorSpecialCustomVolume[t]?.5-.5*Math.cos(2*s*Math.PI*(4*h)):.5-.5*Math.cos(2*s*Math.PI*i.operatorEnvelopeSpeed[t]);case 2:return Math.max(1,2-10*e);case 3:if(i.operatorSpecialCustomVolume[t]){const t=.25/Math.sqrt(h);return e<t?e/t:1/(1+16*h*(e-t))}{const s=i.operatorEnvelopeSpeed[t],h=.25/Math.sqrt(s);return e<h?e/h:1/(1+(e-h)*s)}case 6:return Math.max(-1-e,-2+e);default:throw new Error("Unrecognized operator envelope type.")}}static computeChannelInstrument(t,e,s,h,n,a,l){const r=e.getChannelIsDrum(s),o=t.channels[s],f=e.getPattern(s,t.bar),c=e.channels[s].instruments[null==f?0:f.instrument],u=t.pianoPressed&&s==t.pianoChannel,d=r?i.drumBasePitches[c.wave]:i.keys[e.key].basePitch,m=r?i.drumInterval:1,p=r?i.drumWaveIsSoft[c.wave]?24:60:48,g=4*a/t.samplesPerSecond,b=1/e.partsPerBeat;o.phaseDeltaScale=0,o.filter=1,o.filterScale=1,o.vibratoScale=0,o.harmonyMult=1,o.harmonyVolumeMult=1;let v=0,P=t.arpeggio,L=t.arpSampleCountdown,M=null,R=!0,C=0,F=0,S=1,w=1,k=0,I=0,x=0,O=0,T=0,B=0;for(let t=0;t<i.operatorCount;t++)o.phaseDeltas[t]=0,o.volumeStarts[t]=0,o.volumeDeltas[t]=0,o.volumeLeft[0]=0,o.volumeRight[0]=0;if(u)M=t.pianoPitch,S=w=1,k=I=1,R=!1;else if(null!=f){let s=null,i=null,n=null;for(let t=0;t<f.notes.length;t++)if(f.notes[t].end<=h)i=f.notes[t];else if(f.notes[t].start<=h&&f.notes[t].end>h)s=f.notes[t];else if(f.notes[t].start>h){n=f.notes[t];break}if(null!=s&&null!=i&&i.end!=s.start&&(i=null),null!=s&&null!=n&&n.start!=s.end&&(n=null),null!=s){let r;for(M=s.pitches,v=h-s.start,r=1;r<s.pins.length-1&&!(s.pins[r].time+s.start>h);r++);const o=s.pins[r-1],f=s.pins[r],u=4*s.start,d=4*s.end,m=4*(s.start+o.time),p=4*(s.start+f.time),y=4*h+P,g=4*h+P+1,b=(y-m)/(p-m),A=(g-m)/(p-m);let D=o.volume+(f.volume-o.volume)*b,E=o.volume+(f.volume-o.volume)*A,W=1,N=1,$=o.interval+(f.interval-o.interval)*b,H=o.interval+(f.interval-o.interval)*A,V=o.time+(f.time-o.time)*b,U=o.time+(f.time-o.time)*A,Y=V,z=U;const K=1-(L+l)/a,j=1-L/a;R=y+K-u==0;const q=c.transition;y==u&&(0==q?R=!1:2==q?W=0:3==q?null==i||0==i.pins[i.pins.length-1].volume||0==s.pins[0].volume?W=0:($=.5*(i.pitches[0]+i.pins[i.pins.length-1].interval-s.pitches[0]),Y=.5*i.pins[i.pins.length-1].time,R=!1):4==q?N=0:5==q?$=100:6==q?$=-1:7==q&&(W=6)),g==d&&(0==q?null==n&&s.start+f.time!=e.partsPerBeat*e.beatsPerBar&&(N=0):1==q||2==q?N=0:3==q&&(null==n||0==s.pins[s.pins.length-1].volume||0==n.pins[0].volume?N=0:(H=.5*(n.pitches[0]-s.pitches[0]+s.pins[s.pins.length-1].interval),z*=.5))),C=$+(H-$)*K,F=$+(H-$)*j,k=t.volumeConversion(D+(E-D)*K),I=t.volumeConversion(D+(E-D)*j),S=W+(N-W)*K,w=W+(N-W)*j,x=s.start+V+(U-V)*K,O=s.start+V+(U-V)*j,T=Y+(z-Y)*K,B=Y+(z-Y)*j}}if(null!=M){if(r||1!=c.type){let s=M[0];if(r)0==i.harmNames[c.harm]?1==M.length?s=M[0]+i.octoffValues[c.octoff]:2==M.length?s=M[P>>1]+i.octoffValues[c.octoff]:3==M.length?s=M[3==P?1:P]+i.octoffValues[c.octoff]:4==M.length&&(s=M[P]+i.octoffValues[c.octoff]):1==i.harmNames[c.harm]?1==M.length?s=M[0]+i.octoffValues[c.octoff]:2==M.length?s=(M[1]+M[0])/2+i.octoffValues[c.octoff]:3==M.length?s=(M[1+(P>>1)]+M[0])/2+i.octoffValues[c.octoff]:4==M.length&&(s=(M[(3==P?1:P)+1]+M[0])/2+i.octoffValues[c.octoff]):2==i.harmNames[c.harm]?1==M.length?s=M[0]+i.octoffValues[c.octoff]:2==M.length?s=(M[1]+M[0])/2+i.octoffValues[c.octoff]:3==M.length?s=(M[2]+M[0])/2+i.octoffValues[c.octoff]:4==M.length&&(s=(M[(3==P?2:P)+1]+M[0])/2+i.octoffValues[c.octoff]):3==i.harmNames[c.harm]?1==M.length?s=M[0]+i.octoffValues[c.octoff]:2==M.length?s=(M[1]+M[0])/2+i.octoffValues[c.octoff]:3==M.length?s=(M[2]+M[0])/2+i.octoffValues[c.octoff]:4==M.length&&(s=(M[3]+M[0])/2+i.octoffValues[c.octoff]):4==i.harmNames[c.harm]&&(1==M.length?s=M[0]+i.octoffValues[c.octoff]:2==M.length?s=(M[1]+M[0])/2+i.octoffValues[c.octoff]:3==M.length?s=(M[1+(P>>1)]+M[0])/2+i.octoffValues[c.octoff]:4==M.length&&(s=M[2+(P>>1)]+M[0]+i.octoffValues[c.octoff]));else if(1==i.harmNames[c.harm]){let t=0;2==M.length?t=M[1]-M[0]:3==M.length?t=M[1+(P>>1)]-M[0]:4==M.length&&(t=M[(3==P?1:P)+1]-M[0]),o.harmonyMult=Math.pow(2,t/12),o.harmonyVolumeMult=Math.pow(2,-t/p)}else if(2==i.harmNames[c.harm]){let t=0;2==M.length?t=M[1]-M[0]:3==M.length?t=M[2]-M[0]:4==M.length&&(t=M[(3==P?2:P)+1]-M[0]),o.harmonyMult=Math.pow(2,t/12),o.harmonyVolumeMult=Math.pow(2,-t/p)}else if(3==i.harmNames[c.harm]){let t=0;2==M.length?t=M[1]-M[0]:3==M.length?t=M[2]-M[0]:4==M.length&&(t=M[3]-M[0]),o.harmonyMult=Math.pow(2,t/12),o.harmonyVolumeMult=Math.pow(2,-t/p)}else if(4==i.harmNames[c.harm]){let t=0;2==M.length?t=M[1]-M[0]:3==M.length?t=M[1+(P>>1)]-M[0]:4==M.length&&(t=M[2+(P>>1)]-M[0]),o.harmonyMult=Math.pow(2,t/12),o.harmonyVolumeMult=Math.pow(2,-t/p)}else if(5==i.harmNames[c.harm]){let t=0;2==M.length?t=M[1]-M[0]:3==M.length?t=M[2]-M[0]:4==M.length&&(t=M[3==P?2:P]-M[0]),o.harmonyMult=Math.pow(2,t/12),o.harmonyVolumeMult=Math.pow(2,-t/p)}else 0==i.harmNames[c.harm]&&(2==M.length?s=M[P>>1]:3==M.length?s=M[3==P?1:P]:4==M.length&&(s=M[P]));const h=(s+C)*m,a=(s+F)*m,f=t.frequencyFromPitch(d+h),u=Math.pow(2,-h/p),y=Math.pow(2,-a/p);let b;if(r&&i.drumWaveIsSoft[c.wave]&&(o.filter=Math.min(1,f*n*i.drumPitchFilterMult[c.wave])),r)b=0==e.mix?.19*i.drumVolumes[c.wave]:3==e.mix?.12*i.drumVolumes[c.wave]:.09*i.drumVolumes[c.wave];else{const t=i.filterDecays[c.filter];o.filter=Math.pow(2,-t*g*T);const e=Math.pow(2,-t*g*B);o.filterScale=Math.pow(e/o.filter,1/l),b=.135*i.waveVolumes[c.wave]*i.filterVolumes[c.filter]*i.chorusVolumes[c.chorus]}R&&!r&&o.reset(),o.phaseDeltas[0]=f*n;let v=0;v=2==e.mix?9==c.volume?0:Math.pow(3,-i.volumeValues[c.volume])*i.imuteValues[c.imute]:1==e.mix?c.volume>=5?0:Math.pow(3,-i.volumeMValues[c.volume])*i.imuteValues[c.imute]:c.volume>=5?0:Math.pow(2,-i.volumeMValues[c.volume])*i.imuteValues[c.imute],o.volumeStarts[0]=S*k*u*b*v;const L=w*I*y*b*v;o.volumeDeltas[0]=(L-o.volumeStarts[0])/l,o.volumeLeft[0]=Math.min(1,1+i.ipanValues[c.ipan]),o.volumeRight[0]=Math.min(1,1-i.ipanValues[c.ipan])}else{let s=1,h=0;const a=i.operatorCarrierCounts[c.algorithm];for(let r=0;r<i.operatorCount;r++){const f=r<i.operatorCarrierCounts[c.algorithm],u=i.operatorAssociatedCarrier[c.algorithm][r]-1,v=M[r<M.length?r:u<M.length?u:0]+i.octoffValues[c.octoff]+e.detune/24,P=i.operatorFrequencies[c.operators[r].frequency],L=(v+C)*m+i.operatorCarrierChorus[i.fmChorusNames[c.fmChorus]][u],A=P*t.frequencyFromPitch(d+L)+i.operatorHzOffsets[c.operators[r].frequency];o.phaseDeltas[r]=A*n*i.sineWaveLength,R&&o.reset();const D=y.operatorAmplitudeCurve(c.operators[r].amplitude);let E=0;-1!=i.volumeValues[c.volume]&&2==e.mix||-1!=i.volumeMValues[c.volume]&&2!=e.mix?E=2==e.mix?f?D*i.operatorAmplitudeSigns[c.operators[r].frequency]*(1-i.volumeValues[c.volume]/2.3):D*i.operatorAmplitudeSigns[c.operators[r].frequency]:D*i.operatorAmplitudeSigns[c.operators[r].frequency]*(1-i.volumeMValues[c.volume]/2.3):(-1!=i.volumeValues[c.volume]||-1!=i.volumeMValues[c.volume])&&(E=0);let W=E*i.imuteValues[c.imute],N=E*i.imuteValues[c.imute];if(o.volumeLeft[0]=Math.min(1,1+i.ipanValues[c.ipan]),o.volumeRight[0]=Math.min(1,1-i.ipanValues[c.ipan]),r<a){const t=.03,s=(v+F)*m;let i=0,n=0;3==e.mix?(i=Math.pow(5,-L/p),n=Math.pow(5,-s/p)):(i=Math.pow(2,-L/p),n=Math.pow(2,-s/p)),W*=i*t*S,N*=n*t*w,h+=D}else W*=1.5*i.sineWaveLength,N*=1.5*i.sineWaveLength,s*=1-Math.min(1,c.operators[r].amplitude/15);const $=c.operators[r].envelope;W*=y.computeOperatorEnvelope($,g*T,b*x,k),N*=y.computeOperatorEnvelope($,g*B,b*O,I),o.volumeStarts[r]=W,o.volumeDeltas[r]=(N-W)/l}const r=.3*i.sineWaveLength*c.feedbackAmplitude/15;let f=r*y.computeOperatorEnvelope(c.feedbackEnvelope,g*T,b*x,k),u=r*y.computeOperatorEnvelope(c.feedbackEnvelope,g*B,b*O,I);o.feedbackMult=f,o.feedbackDelta=(u-o.feedbackMult)/l,s*=1-c.feedbackAmplitude/15,s*=1-Math.min(1,Math.max(0,h-1)/2);for(let t=0;t<a;t++)o.volumeStarts[t]*=1+3*s,o.volumeDeltas[t]*=1+3*s}o.phaseDeltaScale=Math.pow(2,(F-C)*m/12/l),o.vibratoScale=v<i.effectVibratoDelays[c.effect]?0:Math.pow(2,i.effectVibratos[c.effect]/12)-1}else{o.reset();for(let t=0;t<i.operatorCount;t++)o.phaseDeltas[0]=0,o.volumeStarts[0]=0,o.volumeDeltas[0]=0,o.volumeLeft[0]=0,o.volumeRight[0]=0}}static getGeneratedSynthesizer(t,e){const s=t.getChannelFingerprint(e);if(null==y.generatedSynthesizers[s]){const h=[],n=[];for(let s=0;s<t.pitchChannelCount;s++)n[s]=t.channels[s].instruments[t.getPatternInstrument(s,e)];for(const e of y.synthSourceTemplate)if(-1!=e.indexOf("#"))if(-1!=e.indexOf("// PITCH"))for(let s=0;s<t.pitchChannelCount;s++)h.push(e.replace(/#/g,s+""));else if(-1!=e.indexOf("// JCHIP"))for(let s=0;s<t.pitchChannelCount;s++)0==n[s].type&&h.push(e.replace(/#/g,s+""));else if(-1!=e.indexOf("// CHIP"))for(let s=0;s<t.pitchChannelCount;s++)(0==n[s].type||3==n[s].type)&&h.push(e.replace(/#/g,s+""));else if(-1!=e.indexOf("// FM")){for(let s=0;s<t.pitchChannelCount;s++)if(1==n[s].type)if(-1!=e.indexOf("$"))for(let t=0;t<i.operatorCount;t++)h.push(e.replace(/#/g,s+"").replace(/\$/g,t+""));else h.push(e.replace(/#/g,s+""))}else if(-1!=e.indexOf("// PWM"))for(let s=0;s<t.pitchChannelCount;s++)3==n[s].type&&h.push(e.replace(/#/g,s+""));else if(-1!=e.indexOf("// CARRIER OUTPUTS")){for(let s=0;s<t.pitchChannelCount;s++)if(1==n[s].type){const t=[];for(let e=0;e<i.operatorCarrierCounts[n[s].algorithm];e++)t.push("channel"+s+"Operator"+e+"Scaled");h.push(e.replace(/#/g,s+"").replace("/*channel"+s+"Operator$Scaled*/",t.join(" + ")))}}else if(-1!=e.indexOf("// NOISE"))for(let s=t.pitchChannelCount;s<t.pitchChannelCount+t.drumChannelCount;s++)h.push(e.replace(/#/g,s+""));else{if(-1==e.indexOf("// ALL"))throw new Error("Missing channel type annotation for line: "+e);for(let s=0;s<t.pitchChannelCount+t.drumChannelCount;s++)h.push(e.replace(/#/g,s+""))}else if(-1!=e.indexOf("// INSERT OPERATOR COMPUTATION HERE")){for(let e=i.operatorCount-1;e>=0;e--)for(const s of y.operatorSourceTemplate)for(let a=0;a<t.pitchChannelCount;a++)if(1==n[a].type)if(-1!=s.indexOf("/* + channel#Operator@Scaled*/")){let t="";for(const s of i.operatorModulatedBy[n[a].algorithm][e])t+=" + channel"+a+"Operator"+(s-1)+"Scaled";const l=i.operatorFeedbackIndices[n[a].feedbackType][e];if(l.length>0){t+=" + channel"+a+"FeedbackMult * (";const e=[];for(const t of l)e.push("channel"+a+"Operator"+(t-1)+"Output");t+=e.join(" + ")+")"}h.push(s.replace(/#/g,a+"").replace(/\$/g,e+"").replace("/* + channel"+a+"Operator@Scaled*/",t))}else h.push(s.replace(/#/g,a+"").replace(/\$/g,e+""))}else h.push(e);y.generatedSynthesizers[s]=new Function("synth","song","dataLeft","dataRight","bufferLength","bufferIndex","samplesPerTick",h.join("\n"))}return y.generatedSynthesizers[s]}frequencyFromPitch(t){return 440*Math.pow(2,(t-69)/12)}volumeConversion(t){return Math.pow(t/3,1.5)}getSamplesPerArpeggio(){if(null==this.song)return 0;const t=4*(this.song.getBeatsPerMinute()/60*this.song.partsPerBeat);return Math.floor(this.samplesPerSecond/t)}}return y.negativePhaseGuard=1e3,y.generatedSynthesizers={},y.synthSourceTemplate=("\n\t\t\tvar sampleTime = 1.0 / synth.samplesPerSecond;\n\t\t\tvar effectYMult = +synth.effectYMult;\n\t\t\tvar limitDecay = +synth.limitDecay;\n\t\t\tvar volume = +synth.volume;\n\t\t\tvar delayLineLeft = synth.delayLineLeft;\n\t\t\tvar delayLineRight = synth.delayLineRight;\n\t\t\tvar reverb = Math.pow(song.reverb / beepbox.Config.reverbRange, 0.667) * 0.425;\n\t\t\tvar blend = Math.pow(song.blend / beepbox.Config.blendRange, 0.667) * 0.425;\n\t\t\tvar mix = song.mix;\n\t\t\tvar muff = Math.pow(song.muff / beepbox.Config.muffRange, 0.667) * 0.425;\n\t\t\tvar detune = song.detune;\n\t\t\tvar riff = Math.pow(song.riff / beepbox.Config.riffRange, 0.667) * 0.425; \n\t\t\tvar sineWave = beepbox.Config.sineWave;\n\t\t\t\n\t\t\t// Initialize instruments based on current pattern.\n\t\t\tvar instrumentChannel# = song.getPatternInstrument(#, synth.bar); // ALL\n\t\t\tvar instrument# = song.channels[#].instruments[instrumentChannel#]; // ALL\n\t\t\tvar channel#Wave = (mix <= 1) ? beepbox.Config.waves[instrument#.wave] : beepbox.Config.wavesMixC[instrument#.wave]; // CHIP\n\t\t\tvar channel#Wave = beepbox.Config.getDrumWave(instrument#.wave); // NOISE\n\t\t\tvar channel#WaveLength = channel#Wave.length; // CHIP\n\t\t\tvar channel#Wave = beepbox.Config.pwmwaves[instrument#.wave]; // PWM\n\t\t\tvar channel#WaveLength = channel#Wave.length; // PWM\n\t\t\tvar channel#FilterBase = (song.mix == 2) ? Math.pow(2 - (blend * 2) + (muff * 2), -beepbox.Config.filterBases[instrument#.filter]) : Math.pow(2, -beepbox.Config.filterBases[instrument#.filter] + (blend * 4) - (muff * 4)); // CHIP\n\t\t\tvar channel#TremoloScale = beepbox.Config.effectTremolos[instrument#.effect]; // PITCH\n\t\t\t\n\t\t\twhile (bufferIndex < bufferLength) {\n\t\t\t\t\n\t\t\t\tvar samples;\n\t\t\t\tvar samplesLeftInBuffer = bufferLength - bufferIndex;\n\t\t\t\tif (synth.arpSampleCountdown <= samplesLeftInBuffer) {\n\t\t\t\t\tsamples = synth.arpSampleCountdown;\n\t\t\t\t} else {\n\t\t\t\t\tsamples = samplesLeftInBuffer;\n\t\t\t\t}\n\t\t\t\tsynth.arpSampleCountdown -= samples;\n\t\t\t\t\n\t\t\t\tvar time = synth.part + synth.beat * song.partsPerBeat;\n\t\t\t\t\n\t\t\t\tbeepbox.Synth.computeChannelInstrument(synth, song, #, time, sampleTime, samplesPerTick, samples); // ALL\n\t\t\t\tvar synthChannel# = synth.channels[#]; // ALL\n\t\t\t\t\n\t\t\t\tvar channel#ChorusA = Math.pow(2.0, (beepbox.Config.chorusOffsets[instrument#.chorus] + beepbox.Config.chorusIntervals[instrument#.chorus] + beepbox.Config.octoffValues[instrument#.octoff] + (detune / 24) * ((riff * beepbox.Config.chorusRiffApp[instrument#.chorus]) + 1)) / 12.0); // CHIP\n\t\t\t\tvar channel#ChorusB = Math.pow(2.0, (beepbox.Config.chorusOffsets[instrument#.chorus] - beepbox.Config.chorusIntervals[instrument#.chorus] + beepbox.Config.octoffValues[instrument#.octoff] + (detune / 24) * ((riff * beepbox.Config.chorusRiffApp[instrument#.chorus]) + 1)) / 12.0); // CHIP\n\t\t\t\tvar channel#ChorusSign = synthChannel#.harmonyVolumeMult * (beepbox.Config.chorusSigns[instrument#.chorus]); // CHIP\n\t\t\t\tchannel#ChorusB *= synthChannel#.harmonyMult; // CHIP\n\t\t\t\tvar channel#ChorusDeltaRatio = channel#ChorusB / channel#ChorusA * ((riff * beepbox.Config.chorusRiffApp[instrument#.chorus]) + 1); // CHIP\n\t\t\t\t\n\t\t\t\tvar channel#PhaseDelta = synthChannel#.phaseDeltas[0] * channel#ChorusA * ((riff * beepbox.Config.chorusRiffApp[instrument#.chorus]) + 1); // CHIP\n\t\t\t\tvar channel#PhaseDelta = synthChannel#.phaseDeltas[0] / 32768.0; // NOISE\n\t\t\t\tvar channel#PhaseDeltaScale = synthChannel#.phaseDeltaScale; // ALL\n\t\t\t\tvar channel#Volume = synthChannel#.volumeStarts[0]; // CHIP\n\t\t\t\tvar channel#Volume = synthChannel#.volumeStarts[0]; // NOISE\n\t\t\t\tvar channel#VolumeLeft = synthChannel#.volumeLeft[0]; // ALL\n\t\t\t\tvar channel#VolumeRight = synthChannel#.volumeRight[0]; // ALL\n\t\t\t\tvar channel#VolumeDelta = synthChannel#.volumeDeltas[0]; // CHIP\n\t\t\t\tvar channel#VolumeDelta = synthChannel#.volumeDeltas[0]; // NOISE\n\t\t\t\tvar channel#Filter = synthChannel#.filter * channel#FilterBase; // CHIP\n\t\t\t\tvar channel#Filter = synthChannel#.filter; // NOISE\n\t\t\t\tvar channel#FilterScale = synthChannel#.filterScale; // CHIP\n\t\t\t\tvar channel#VibratoScale = synthChannel#.vibratoScale; // PITCH\n\t\t\t\t\n\t\t\t\tvar effectY     = Math.sin(synth.effectPhase);\n\t\t\t\tvar prevEffectY = Math.sin(synth.effectPhase - synth.effectAngle);\n\t\t\t\t\n\t\t\t\tvar channel#PhaseA = synth.channels[#].phases[0] % 1; // CHIP\n\t\t\t\tvar channel#PhaseB = synth.channels[#].phases[1] % 1; // CHIP\n\t\t\t\tvar channel#Phase  = synth.channels[#].phases[0] % 1; // NOISE\n\t\t\t\t\n\t\t\t\tvar channel#Operator$Phase       = ((synth.channels[#].phases[$] % 1) + "+y.negativePhaseGuard+") * "+i.sineWaveLength+"; // FM\n\t\t\t\tvar channel#Operator$PhaseDelta  = synthChannel#.phaseDeltas[$]; // FM\n\t\t\t\tvar channel#Operator$OutputMult  = synthChannel#.volumeStarts[$]; // FM\n\t\t\t\tvar channel#Operator$OutputDelta = synthChannel#.volumeDeltas[$]; // FM\n\t\t\t\tvar channel#Operator$Output      = synthChannel#.feedbackOutputs[$]; // FM\n\t\t\t\tvar channel#FeedbackMult         = synthChannel#.feedbackMult; // FM\n\t\t\t\tvar channel#FeedbackDelta        = synthChannel#.feedbackDelta; // FM\n\t\t\t\t\n\t\t\t\tvar channel#SampleLeft = +synth.channels[#].sampleLeft; // ALL\n\t\t\t\tvar channel#SampleRight = +synth.channels[#].sampleRight; // ALL\n\t\t\t\t\n\t\t\t\tvar delayPosLeft = 0|synth.delayPosLeft;\n\t\t\t\tvar delayFeedback0Left = +synth.delayFeedback0Left;\n\t\t\t\tvar delayFeedback1Left = +synth.delayFeedback1Left;\n\t\t\t\tvar delayFeedback2Left = +synth.delayFeedback2Left;\n\t\t\t\tvar delayFeedback3Left = +synth.delayFeedback3Left;\n\t\t\t\tvar delayPosRight = 0|synth.delayPosRight;\n\t\t\t\tvar delayFeedback0Right = +synth.delayFeedback0Right;\n\t\t\t\tvar delayFeedback1Right = +synth.delayFeedback1Right;\n\t\t\t\tvar delayFeedback2Right = +synth.delayFeedback2Right;\n\t\t\t\tvar delayFeedback3Right = +synth.delayFeedback3Right;\n\t\t\t\tvar limit = +synth.limit;\n\t\t\t\t\n\t\t\t\twhile (samples) {\n\t\t\t\t\tvar channel#Vibrato = 1.0 + channel#VibratoScale * effectY; // PITCH\n\t\t\t\t\tvar channel#Tremolo = 1.0 + channel#TremoloScale * (effectY - 1.0); // PITCH\n\t\t\t\t\tvar temp = effectY;\n\t\t\t\t\teffectY = effectYMult * effectY - prevEffectY;\n\t\t\t\t\tprevEffectY = temp;\n\t\t\t\t\t\n\t\t\t\t\tchannel#SampleLeft += ((channel#Wave[0|(channel#PhaseA * channel#WaveLength)] + channel#Wave[0|(channel#PhaseB * channel#WaveLength)] * channel#ChorusSign) * channel#Volume * channel#Tremolo - channel#SampleLeft) * channel#Filter * channel#VolumeLeft; // CHIP \n\t\t\t\t\tchannel#SampleLeft += (channel#Wave[0|(channel#Phase * 32768.0)] * channel#Volume - channel#SampleLeft) * channel#Filter * channel#VolumeLeft; // NOISE\n\t\t\t\t\tchannel#SampleRight += ((channel#Wave[0|(channel#PhaseA * channel#WaveLength)] + channel#Wave[0|(channel#PhaseB * channel#WaveLength)] * channel#ChorusSign) * channel#Volume * channel#Tremolo - channel#SampleRight) * channel#Filter * channel#VolumeRight; // CHIP \n\t\t\t\t\tchannel#SampleRight += (channel#Wave[0|(channel#Phase * 32768.0)] * channel#Volume - channel#SampleRight) * channel#Filter * channel#VolumeRight; // NOISE\n\t\t\t\t\tchannel#Volume += channel#VolumeDelta; // CHIP\n\t\t\t\t\tchannel#Volume += channel#VolumeDelta; // NOISE\n\t\t\t\t\tchannel#PhaseA += channel#PhaseDelta * channel#Vibrato; // CHIP\n\t\t\t\t\tchannel#PhaseB += channel#PhaseDelta * channel#Vibrato * channel#ChorusDeltaRatio; // CHIP\n\t\t\t\t\tchannel#Phase += channel#PhaseDelta; // NOISE\n\t\t\t\t\tchannel#Filter *= channel#FilterScale; // CHIP\n\t\t\t\t\tchannel#PhaseA -= 0|channel#PhaseA; // CHIP\n\t\t\t\t\tchannel#PhaseB -= 0|channel#PhaseB; // CHIP\n\t\t\t\t\tchannel#Phase -= 0|channel#Phase; // NOISE\n\t\t\t\t\tchannel#PhaseDelta *= channel#PhaseDeltaScale; // CHIP\n\t\t\t\t\tchannel#PhaseDelta *= channel#PhaseDeltaScale; // NOISE\n\t\t\t\t\t\n\t\t\t\t\t// INSERT OPERATOR COMPUTATION HERE\n\t\t\t\t\tchannel#SampleLeft = channel#Tremolo * (/*channel#Operator$Scaled*/) * channel#VolumeLeft; // CARRIER OUTPUTS\n\t\t\t\t\tchannel#SampleRight = channel#Tremolo * (/*channel#Operator$Scaled*/) * channel#VolumeRight; // CARRIER OUTPUTS\n\t\t\t\t\tchannel#FeedbackMult += channel#FeedbackDelta; // FM\n\t\t\t\t\tchannel#Operator$OutputMult += channel#Operator$OutputDelta; // FM\n\t\t\t\t\tchannel#Operator$Phase += channel#Operator$PhaseDelta * channel#Vibrato; // FM\n\t\t\t\t\tchannel#Operator$PhaseDelta *= channel#PhaseDeltaScale; // FM\n\t\t\t\t\t\n\t\t\t\t\t// Reverb, implemented using a feedback delay network with a Hadamard matrix and lowpass filters.\n\t\t\t\t\t// good ratios:    0.555235 + 0.618033 + 0.818 +   1.0 = 2.991268\n\t\t\t\t\t// Delay lengths:  3041     + 3385     + 4481  +  5477 = 16384 = 2^14\n\t\t\t\t\t// Buffer offsets: 3041    -> 6426   -> 10907 -> 16384\n\t\t\t\t\tvar delayPos1Left = (delayPosLeft +  3041) & 0x3FFF;\n\t\t\t\t\tvar delayPos2Left = (delayPosLeft +  6426) & 0x3FFF;\n\t\t\t\t\tvar delayPos3Left = (delayPosLeft + 10907) & 0x3FFF;\n\t\t\t\t\tvar delaySampleLeft0 = (delayLineLeft[delayPosLeft]\n\t\t\t\t\t\t+ channel#SampleLeft // PITCH\n\t\t\t\t\t);\n\t\t\t\t\tvar delayPos1Right = (delayPosRight +  3041) & 0x3FFF;\n\t\t\t\t\tvar delayPos2Right = (delayPosRight +  6426) & 0x3FFF;\n\t\t\t\t\tvar delayPos3Right = (delayPosRight + 10907) & 0x3FFF;\n\t\t\t\t\tvar delaySampleRight0 = (delayLineRight[delayPosRight]\n\t\t\t\t\t\t+ channel#SampleRight // PITCH\n\t\t\t\t\t);\n\t\t\t\t\tvar delaySampleLeft1 = delayLineLeft[delayPos1Left];\n\t\t\t\t\tvar delaySampleLeft2 = delayLineLeft[delayPos2Left];\n\t\t\t\t\tvar delaySampleLeft3 = delayLineLeft[delayPos3Left];\n\t\t\t\t\tvar delayTemp0Left = -delaySampleLeft0 + delaySampleLeft1;\n\t\t\t\t\tvar delayTemp1Left = -delaySampleLeft0 - delaySampleLeft1;\n\t\t\t\t\tvar delayTemp2Left = -delaySampleLeft2 + delaySampleLeft3;\n\t\t\t\t\tvar delayTemp3Left = -delaySampleLeft2 - delaySampleLeft3;\n\t\t\t\t\tdelayFeedback0Left += ((delayTemp0Left + delayTemp2Left) * reverb - delayFeedback0Left) * 0.5;\n\t\t\t\t\tdelayFeedback1Left += ((delayTemp1Left + delayTemp3Left) * reverb - delayFeedback1Left) * 0.5;\n\t\t\t\t\tdelayFeedback2Left += ((delayTemp0Left - delayTemp2Left) * reverb - delayFeedback2Left) * 0.5;\n\t\t\t\t\tdelayFeedback3Left += ((delayTemp1Left - delayTemp3Left) * reverb - delayFeedback3Left) * 0.5;\n\t\t\t\t\tdelayLineLeft[delayPos1Left] = delayFeedback0Left;\n\t\t\t\t\tdelayLineLeft[delayPos2Left] = delayFeedback1Left;\n\t\t\t\t\tdelayLineLeft[delayPos3Left] = delayFeedback2Left;\n\t\t\t\t\tdelayLineLeft[delayPosLeft ] = delayFeedback3Left;\n\t\t\t\t\tdelayPosLeft = (delayPosLeft + 1) & 0x3FFF;\n\t\t\t\t\t\n\t\t\t\t\tvar delaySampleRight1 = delayLineRight[delayPos1Right];\n\t\t\t\t\tvar delaySampleRight2 = delayLineRight[delayPos2Right];\n\t\t\t\t\tvar delaySampleRight3 = delayLineRight[delayPos3Right];\n\t\t\t\t\tvar delayTemp0Right = -delaySampleRight0 + delaySampleRight1;\n\t\t\t\t\tvar delayTemp1Right = -delaySampleRight0 - delaySampleRight1;\n\t\t\t\t\tvar delayTemp2Right = -delaySampleRight2 + delaySampleRight3;\n\t\t\t\t\tvar delayTemp3Right = -delaySampleRight2 - delaySampleRight3;\n\t\t\t\t\tdelayFeedback0Right += ((delayTemp0Right + delayTemp2Right) * reverb - delayFeedback0Right) * 0.5;\n\t\t\t\t\tdelayFeedback1Right += ((delayTemp1Right + delayTemp3Right) * reverb - delayFeedback1Right) * 0.5;\n\t\t\t\t\tdelayFeedback2Right += ((delayTemp0Right - delayTemp2Right) * reverb - delayFeedback2Right) * 0.5;\n\t\t\t\t\tdelayFeedback3Right += ((delayTemp1Right - delayTemp3Right) * reverb - delayFeedback3Right) * 0.5;\n\t\t\t\t\tdelayLineRight[delayPos1Right] = delayFeedback0Right;\n\t\t\t\t\tdelayLineRight[delayPos2Right] = delayFeedback1Right;\n\t\t\t\t\tdelayLineRight[delayPos3Right] = delayFeedback2Right;\n\t\t\t\t\tdelayLineRight[delayPosRight ] = delayFeedback3Right;\n\t\t\t\t\tdelayPosRight = (delayPosRight + 1) & 0x3FFF;\n\t\t\t\t\t\n\t\t\t\t\tvar sampleLeft = delaySampleLeft0 + delaySampleLeft1 + delaySampleLeft2 + delaySampleLeft3\n\t\t\t\t\t\t+ channel#SampleLeft // NOISE\n\t\t\t\t\t;\n\t\t\t\t\t\n\t\t\t\t\tvar sampleRight = delaySampleRight0 + delaySampleRight1 + delaySampleRight2 + delaySampleRight3\n\t\t\t\t\t\t+ channel#SampleRight // NOISE\n\t\t\t\t\t;\n\t\t\t\t\t\n\t\t\t\t\tvar abs = sampleLeft < 0.0 ? -sampleLeft : sampleLeft;\n\t\t\t\t\tlimit -= limitDecay;\n\t\t\t\t\tif (limit < abs) limit = abs;\n\t\t\t\t\tsampleLeft /= limit * 0.75 + 0.25;\n\t\t\t\t\tsampleLeft *= volume;\n\t\t\t\t\tsampleLeft = sampleLeft;\n\t\t\t\t\tdataLeft[bufferIndex] = sampleLeft;\n\t\t\t\t\tsampleRight /= limit * 0.75 + 0.25;\n\t\t\t\t\tsampleRight *= volume;\n\t\t\t\t\tsampleRight = sampleRight;\n\t\t\t\t\tdataRight[bufferIndex] = sampleRight;\n\t\t\t\t\tbufferIndex++;\n\t\t\t\t\tsamples--;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tsynthChannel#.phases[0] = channel#PhaseA; // CHIP\n\t\t\t\tsynthChannel#.phases[1] = channel#PhaseB; // CHIP\n\t\t\t\tsynthChannel#.phases[0] = channel#Phase; // NOISE\n\t\t\t\tsynthChannel#.phases[$] = channel#Operator$Phase / "+i.sineWaveLength+"; // FM\n\t\t\t\tsynthChannel#.feedbackOutputs[$] = channel#Operator$Output; // FM\n\t\t\t\tsynthChannel#.sampleLeft = channel#SampleLeft; // ALL\n\t\t\t\tsynthChannel#.sampleRight = channel#SampleRight; // ALL\n\t\t\t\t\n\t\t\t\tsynth.delayPosLeft = delayPosLeft;\n\t\t\t\tsynth.delayFeedback0Left = delayFeedback0Left;\n\t\t\t\tsynth.delayFeedback1Left = delayFeedback1Left;\n\t\t\t\tsynth.delayFeedback2Left = delayFeedback2Left;\n\t\t\t\tsynth.delayFeedback3Left = delayFeedback3Left;\n\t\t\t\tsynth.delayPosRight = delayPosRight;\n\t\t\t\tsynth.delayFeedback0Right = delayFeedback0Right;\n\t\t\t\tsynth.delayFeedback1Right = delayFeedback1Right;\n\t\t\t\tsynth.delayFeedback2Right = delayFeedback2Right;\n\t\t\t\tsynth.delayFeedback3Right = delayFeedback3Right;\n\t\t\t\tsynth.limit = limit;\n\t\t\t\t\n\t\t\t\tif (effectYMult * effectY - prevEffectY > prevEffectY) {\n\t\t\t\t\tsynth.effectPhase = Math.asin(effectY);\n\t\t\t\t} else {\n\t\t\t\t\tsynth.effectPhase = Math.PI - Math.asin(effectY);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (synth.arpSampleCountdown == 0) {\n\t\t\t\t\tsynth.arpeggio++;\n\t\t\t\t\tsynth.arpSampleCountdown = samplesPerTick;\n\t\t\t\t\tif (synth.arpeggio == 4) {\n\t\t\t\t\t\tsynth.arpeggio = 0;\n\t\t\t\t\t\tsynth.part++;\n\t\t\t\t\t\tif (synth.part == song.partsPerBeat) {\n\t\t\t\t\t\t\tsynth.part = 0;\n\t\t\t\t\t\t\tsynth.beat++;\n\t\t\t\t\t\t\tif (synth.beat == song.beatsPerBar) {\n\t\t\t\t\t\t\t\t// The bar ended, may need to regenerate synthesizer.\n\t\t\t\t\t\t\t\treturn bufferIndex;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t\n\t\t\t// Indicate that the buffer is finished generating.\n\t\t\treturn -1;\n\t\t").split("\n"),y.operatorSourceTemplate=("\n\t\t\t\t\t\tvar channel#Operator$PhaseMix = channel#Operator$Phase/* + channel#Operator@Scaled*/;\n\t\t\t\t\t\tvar channel#Operator$PhaseInt = channel#Operator$PhaseMix|0;\n\t\t\t\t\t\tvar channel#Operator$Index    = channel#Operator$PhaseInt & "+i.sineWaveMask+";\n\t\t\t\t\t\tvar channel#Operator$Sample   = sineWave[channel#Operator$Index];\n\t\t\t\t\t\tchannel#Operator$Output       = channel#Operator$Sample + (sineWave[channel#Operator$Index + 1] - channel#Operator$Sample) * (channel#Operator$PhaseMix - channel#Operator$PhaseInt);\n\t\t\t\t\t\tvar channel#Operator$Scaled   = channel#Operator$OutputMult * channel#Operator$Output;\n\t\t").split("\n"),t.Synth=y,t.Tone=class{constructor(){this.pitches=[0,0,0,0],this.pitchCount=0,this.chordSize=0,this.drumsetPitch=0,this.note=null,this.prevNote=null,this.nextNote=null,this.prevNotePitchIndex=0,this.nextNotePitchIndex=0,this.active=!1,this.noteStart=0,this.noteEnd=0,this.noteLengthTicks=0,this.ticksSinceReleased=0,this.liveInputSamplesHeld=0,this.lastInterval=0,this.lastVolume=0,this.stereoVolume1=0,this.stereoVolume2=0,this.stereoOffset=0,this.stereoDelay=0,this.sample=0,this.phases=[],this.phaseDeltas=[],this.volumeStarts=[],this.volumeDeltas=[],this.volumeStart=0,this.volumeDelta=0,this.phaseDeltaScale=0,this.pulseWidth=0,this.pulseWidthDelta=0,this.filter=0,this.filterScale=0,this.filterSample0=0,this.filterSample1=0,this.vibratoScale=0,this.intervalMult=0,this.intervalVolumeMult=1,this.feedbackOutputs=[],this.feedbackMult=0,this.feedbackDelta=0,this.reset()}reset(){for(let t=0;t<i.operatorCount;t++)this.phases[t]=0,this.feedbackOutputs[t]=0;this.sample=0,this.filterSample0=0,this.filterSample1=0,this.liveInputSamplesHeld=0}},Object.defineProperty(t,"F",{value:!0}),t}({});
//# sourceMappingURL=beepbox_synth.min.js.map